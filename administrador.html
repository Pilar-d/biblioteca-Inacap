<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√≥dulo Administrador - Biblioteca Digital INACAP</title>

<!-- Librer√≠as para Reportes y Gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    :root {
        --primary: #c4bf2a;
        --primary-dark: #a8a424;
        --secondary: #429111;
        --secondary-dark: #36770e;
        --danger: #f24949;
        --danger-dark: #d12f2f;
        --warning: #f59e0b;
        --warning-dark: #d97706;
        --success: #10b981;
        --success-dark: #059669;
        --info: #1e90ff;
        --info-dark: #0069d9;
        --purple: #8b5cf6;
        --purple-dark: #7c3aed;
        --light: #f8fafc;
        --dark: #1f2937;
        --gray: #6b7280;
        --gray-light: #e5e7eb;
        --white: #ffffff;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.1);
        --radius: 16px;
        --radius-sm: 10px;
        --radius-xs: 6px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e5e7eb 100%);
        min-height: 100vh;
        color: var(--dark);
        line-height: 1.6;
    }

    /* Header */
    .header {
        background: linear-gradient(135deg, var(--white) 0%, #f9fafb 100%);
        padding: 1.25rem 2.5rem;
        box-shadow: var(--shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1000;
        border-bottom: 2px solid var(--gray-light);
        backdrop-filter: blur(10px);
    }

    .logo-container {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .logo {
        position: relative;
        width: 85px;
        height: 85px;
    }

    .logo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary);
        box-shadow: 0 6px 20px rgba(196, 191, 42, 0.25);
        transition: var(--transition);
    }

    .logo:hover img {
        transform: rotate(8deg) scale(1.05);
        box-shadow: 0 8px 30px rgba(196, 191, 42, 0.4);
    }

    .header-info h1 {
        font-size: 1.6rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.25rem;
        background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-info small {
        color: var(--gray);
        font-size: 0.9rem;
        background: var(--light);
        padding: 0.35rem 1rem;
        border-radius: 20px;
        border: 1px solid var(--gray-light);
        font-weight: 500;
    }

    /* User Info */
    .user-container {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.85rem 1.75rem;
        background: var(--white);
        border-radius: var(--radius);
        border: 1px solid var(--gray-light);
        box-shadow: var(--shadow);
        transition: var(--transition);
    }

    .user-profile:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
    }

    .user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-weight: 700;
        font-size: 1.3rem;
        box-shadow: 0 4px 12px rgba(66, 145, 17, 0.3);
    }

    .user-details {
        text-align: right;
    }

    .user-name {
        font-weight: 800;
        color: var(--dark);
        font-size: 1.1rem;
    }

    .user-role {
        color: var(--primary);
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .last-access {
        font-size: 0.8rem;
        color: var(--gray);
        margin-top: 0.25rem;
    }

    .logout-btn {
        padding: 0.85rem 1.75rem;
        background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
        color: var(--white);
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 700;
        font-size: 0.95rem;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 6px 20px rgba(242, 73, 73, 0.25);
    }

    .logout-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(242, 73, 73, 0.4);
    }

    .logout-btn:active {
        transform: translateY(-1px);
    }

    /* Main Container */
    .main-container {
        display: flex;
        min-height: calc(100vh - 95px);
    }

    /* Sidebar */
    .sidebar {
        width: 300px;
        background: linear-gradient(180deg, var(--white) 0%, #fafafa 100%);
        padding: 2.5rem 0;
        box-shadow: 3px 0 20px rgba(0, 0, 0, 0.08);
        border-right: 1px solid var(--gray-light);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .nav-item {
        padding: 1.25rem 2.5rem;
        margin: 0 1rem;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 1.25rem;
        font-weight: 600;
        color: var(--gray);
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .nav-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
        transform: translateX(-10px);
        transition: var(--transition);
    }

    .nav-item:hover {
        background: var(--light);
        color: var(--primary);
        transform: translateX(10px);
        border-color: var(--gray-light);
    }

    .nav-item:hover::before {
        transform: translateX(0);
    }

    .nav-item.active {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: var(--white);
        box-shadow: 0 6px 20px rgba(196, 191, 42, 0.3);
        border-color: var(--primary);
        transform: translateX(10px);
    }

    .nav-item.active::before {
        transform: translateX(0);
        background: var(--white);
    }

    .nav-item.active:hover {
        background: linear-gradient(135deg, var(--primary-dark) 0%, #8f8b1e 100%);
        transform: translateX(10px);
    }

    .nav-icon {
        font-size: 1.4rem;
        width: 28px;
        text-align: center;
    }

    /* Content */
    .content {
        flex: 1;
        padding: 2.5rem;
        overflow-y: auto;
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
    }

    .content-section {
        display: none;
        animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeIn {
        from { 
            opacity: 0; 
            transform: translateY(20px) scale(0.98); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0) scale(1); 
        }
    }

    .content-section.active {
        display: block;
    }

    /* Section Headers */
    .section-header {
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--gray-light);
    }

    .section-title {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.75rem;
        position: relative;
        display: inline-block;
    }

    .section-title::after {
        content: '';
        position: absolute;
        bottom: -12px;
        left: 0;
        width: 80px;
        height: 5px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: 3px;
    }

    .section-subtitle {
        color: var(--gray);
        font-size: 1.1rem;
        max-width: 800px;
        line-height: 1.6;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .stat-card {
        background: var(--white);
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-light);
        transition: var(--transition);
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-xl);
        border-color: var(--primary);
    }

    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        display: inline-block;
        padding: 1rem;
        border-radius: 50%;
        background: linear-gradient(135deg, #f0f9ff 0%, #e1f5fe 100%);
        color: var(--primary);
    }

    .stat-number {
        font-size: 2.8rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.5rem;
        line-height: 1;
    }

    .stat-label {
        font-size: 1rem;
        color: var(--gray);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Cards */
    .card {
        background: var(--white);
        border-radius: var(--radius);
        padding: 2.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        border: 1px solid var(--gray-light);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
    }

    .card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-3px);
    }

    .card-header {
        margin-bottom: 1.75rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-light);
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .card-title i {
        font-size: 1.3rem;
        color: var(--primary);
    }

    .card-description {
        color: var(--gray);
        font-size: 0.95rem;
    }

    /* Buttons */
    .btn {
        padding: 0.85rem 1.75rem;
        border: none;
        border-radius: var(--radius-sm);
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
        color: var(--white);
    }

    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(66, 145, 17, 0.3);
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: var(--white);
    }

    .btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(196, 191, 42, 0.3);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
        color: var(--white);
    }

    .btn-success:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
        color: var(--white);
    }

    .btn-danger:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
    }

    .btn-outline {
        background: transparent;
        color: var(--primary);
        border: 2px solid var(--primary);
    }

    .btn-outline:hover {
        background: var(--primary);
        color: var(--white);
        transform: translateY(-3px);
    }

    /* Forms */
    .form-container {
        background: var(--light);
        border-radius: var(--radius-sm);
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--gray-light);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--dark);
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control {
        width: 100%;
        padding: 0.85rem 1.25rem;
        border: 2px solid var(--gray-light);
        border-radius: var(--radius-xs);
        font-size: 1rem;
        background: var(--white);
        transition: var(--transition);
        color: var(--dark);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(196, 191, 42, 0.1);
    }

    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }

    /* Tables */
    .table-container {
        overflow-x: auto;
        border-radius: var(--radius-sm);
        border: 1px solid var(--gray-light);
        box-shadow: var(--shadow);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
        background: var(--white);
    }

    th {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: var(--white);
        font-weight: 700;
        padding: 1.25rem 1.5rem;
        text-align: left;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.9rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    td {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--gray-light);
        color: var(--dark);
    }

    tr:hover {
        background: linear-gradient(90deg, rgba(196, 191, 42, 0.05) 0%, rgba(66, 145, 17, 0.05) 100%);
    }

    .book-img {
        width: 70px;
        height: 90px;
        object-fit: cover;
        border-radius: var(--radius-xs);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-light);
        transition: var(--transition);
    }

    .book-img:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-lg);
    }

    /* Badges */
    .badge {
        display: inline-block;
        padding: 0.35rem 0.85rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--white);
        box-shadow: var(--shadow);
    }

    .badge-success {
        background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
    }

    .badge-warning {
        background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
    }

    .badge-danger {
        background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
    }

    .badge-info {
        background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
    }

    .badge-purple {
        background: linear-gradient(135deg, var(--purple) 0%, var(--purple-dark) 100%);
    }

    /* Charts */
    .chart-container {
        position: relative;
        height: 400px;
        margin-top: 2rem;
        background: var(--white);
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-light);
    }

    /* Export Buttons */
    .export-container {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: var(--white);
        border-radius: var(--radius);
        border: 2px dashed var(--gray-light);
    }

    .empty-state i {
        font-size: 3.5rem;
        color: var(--gray-light);
        margin-bottom: 1.5rem;
        opacity: 0.6;
    }

    .empty-state h3 {
        color: var(--gray);
        margin-bottom: 0.75rem;
        font-weight: 600;
    }

    .empty-state p {
        color: var(--gray);
        font-size: 1rem;
        max-width: 400px;
        margin: 0 auto;
    }

    /* Loading */
    .loading {
        text-align: center;
        padding: 3rem;
        color: var(--gray);
    }

    .loading-spinner {
        display: inline-block;
        width: 50px;
        height: 50px;
        border: 3px solid var(--gray-light);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .main-container {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            padding: 1rem;
            flex-direction: row;
            overflow-x: auto;
            border-right: none;
            border-bottom: 1px solid var(--gray-light);
        }

        .nav-item {
            flex-shrink: 0;
            margin: 0 0.5rem;
            padding: 1rem 1.5rem;
            font-size: 0.9rem;
        }

        .content {
            padding: 1.5rem;
        }

        .header {
            padding: 1rem;
            flex-direction: column;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .user-container {
            width: 100%;
            justify-content: space-between;
        }

        .logo-container {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .section-title {
            font-size: 1.8rem;
        }

        .card {
            padding: 1.5rem;
        }

        .table-container {
            font-size: 0.85rem;
        }

        th, td {
            padding: 1rem;
        }
    }

    @media (max-width: 480px) {
        .nav-item {
            padding: 0.75rem 1rem;
        }

        .nav-icon {
            font-size: 1.2rem;
        }

        .user-profile {
            flex-direction: column;
            text-align: center;
            padding: 1rem;
        }

        .user-details {
            text-align: center;
        }

        .logout-btn {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .export-container {
            flex-direction: column;
        }

        .export-container .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
</head>
<body>
<header class="header">
    <div class="logo-container">
        <div class="logo">
            <img src="img/inacap-logo.png" alt="Logo INACAP">
        </div>
        <div class="header-info">
            <h1>Sistema Biblioteca Digital</h1>
            <small>M√≥dulo Administrador</small>
        </div>
    </div>

    <div class="user-container">
        <div class="user-profile">
            <div class="user-avatar" id="userAvatar">A</div>
            <div class="user-details">
                <div class="user-name" id="userName">Administrador</div>
                <div class="user-role" id="userRole">Administrador</div>
                <div class="last-access" id="lastAccess"></div>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">
            <span>üö™</span> Cerrar Sesi√≥n
        </button>
    </div>
</header>

<div class="main-container">
    <nav class="sidebar">
        <div class="nav-item active" onclick="showSection('dashboard', this)">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="showSection('usuarios', this)">
            <span class="nav-icon">üë•</span>
            <span>Gesti√≥n Usuarios</span>
        </div>
        <div class="nav-item" onclick="showSection('libros', this)">
            <span class="nav-icon">üìö</span>
            <span>Gesti√≥n Libros</span>
        </div>
        <div class="nav-item" onclick="showSection('auditorias', this)">
            <span class="nav-icon">üîê</span>
            <span>Auditor√≠as</span>
        </div>
        <div class="nav-item" onclick="showSection('prestamos', this)">
            <span class="nav-icon">üìñ</span>
            <span>Estado Pr√©stamos</span>
        </div>
        <div class="nav-item" onclick="showSection('reportes', this)">
            <span class="nav-icon">üìà</span>
            <span>Reportes</span>
        </div>
    </nav>

    <main class="content">
        <!-- DASHBOARD -->
        <section id="dashboard" class="content-section active">
            <div class="section-header">
                <h1 class="section-title">üìä Dashboard Principal</h1>
                <p class="section-subtitle">Panel de control con estad√≠sticas y m√©tricas clave del sistema de biblioteca digital.</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-number" id="totalUsuarios">0</div>
                    <div class="stat-label">Usuarios Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-number" id="totalLibros">0</div>
                    <div class="stat-label">Libros en Cat√°logo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìñ</div>
                    <div class="stat-number" id="prestamosActivos">0</div>
                    <div class="stat-label">Pr√©stamos Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-number" id="multasPendientes">0</div>
                    <div class="stat-label">Multas Pendientes</div>
                </div>
            </div>

           <section>
    <div class="card">
        <div class="card-header">
            <h2 class="card-title"><i>üìà</i> Distribuci√≥n de Pr√©stamos</h2>
            <p class="card-description">An√°lisis visual del estado actual de los pr√©stamos en el sistema.</p>
        </div>
        <div class="chart-container">
            <canvas id="chartPrestamos"></canvas>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('chartPrestamos').getContext('2d');
    
    // Datos de ejemplo - puedes reemplazar con datos reales
    const data = {
        labels: ['Activos', 'Vencidos', 'Pagados', 'Aprobados', 'Rechazados'],
        datasets: [{
            data: [45, 10, 30, 8, 7],
            backgroundColor: [
                '#4CAF50', // Verde para activos
                '#F44336', // Rojo para vencidos
                '#2196F3', // Azul para pagados
                '#FFC107', // Amarillo para aprobados
                '#9E9E9E'  // Gris para rechazados
            ],
            borderColor: '#fff',
            borderWidth: 2,
            hoverOffset: 15
        }]
    };

    // Configuraci√≥n del gr√°fico
    const config = {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    };

    // Crear el gr√°fico
    new Chart(ctx, config);
});
</script>

<style>
.chart-container {
    position: relative;
    height: 400px;
    padding: 20px;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
}

.card-header {
    padding: 24px 24px 0 24px;
}

.card-title {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-description {
    color: #666;
    margin-bottom: 20px;
    font-size: 0.9rem;
}
</style>
        </section>

        <!-- USUARIOS -->
        <section id="usuarios" class="content-section">
            <div class="section-header">
                <h1 class="section-title">üë• Gesti√≥n de Usuarios</h1>
                <p class="section-subtitle">Administraci√≥n completa de usuarios del sistema: estudiantes, bibliotecarios y administradores.</p>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i>‚ûï</i> Agregar Nuevo Usuario</h2>
                    <p class="card-description">Complete el formulario para registrar un nuevo usuario en el sistema.</p>
                </div>
                
                <div id="formUsuario" class="form-container" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" id="nombreUsuario" class="form-control" placeholder="Ej: Juan P√©rez">
                        </div>
                        <div class="form-group">
                            <label>Correo Electr√≥nico</label>
                            <input type="email" id="emailUsuario" class="form-control" placeholder="Ej: juan.perez@inacap.cl">
                        </div>
                        <div class="form-group">
                            <label>Rol del Usuario</label>
                            <select id="rolUsuario" class="form-control">
                                <option value="estudiante">üë®‚Äçüéì Estudiante</option>
                                <option value="bibliotecario">üë©‚Äçüíº Bibliotecario</option>
                                <option value="administrador">üë®‚Äçüíº Administrador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Carrera (solo estudiantes)</label>
                            <input type="text" id="carreraUsuario" class="form-control" placeholder="Ej: Ingenier√≠a Inform√°tica">
                        </div>
                        <div class="form-group">
                            <label>Nombre de Usuario</label>
                            <input type="text" id="usernameUsuario" class="form-control" placeholder="Ej: juan.perez">
                        </div>
                        <div class="form-group">
                            <label>Contrase√±a</label>
                            <input type="password" id="passwordUsuario" class="form-control" placeholder="Ingrese una contrase√±a segura">
                            <small id="passwordHelp" class="form-text text-muted"></small>
                        </div>
                        <script>
                            document.getElementById("passwordUsuario").addEventListener("input", function () {
                                const password = this.value;
                                const helpText = document.getElementById("passwordHelp");

                                // Validaci√≥n de contrase√±a segura
                                const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&._\-]).{8,}$/;

                                if (password.length === 0) {
                                    helpText.textContent = "";
                                    this.style.borderColor = "";
                                    return;
                                }

                                if (regex.test(password)) {
                                    helpText.textContent = "Contrase√±a v√°lida ‚úî";
                                    helpText.style.color = "green";
                                    this.style.borderColor = "green";
                                    this.setCustomValidity(""); // Permite continuar
                                } else {
                                    helpText.textContent = "Debe incluir letras, n√∫meros, s√≠mbolos y m√≠nimo 8 caracteres ‚ùå";
                                    helpText.style.color = "red";
                                    this.style.borderColor = "red";
                                    this.setCustomValidity("Contrase√±a insegura"); // ‚ùå No permite continuar
                                }
                            });


                        </script>

                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-success" onclick="guardarUsuario()">
                            <span>üíæ</span> Guardar Usuario
                        </button>
                        <button class="btn btn-outline" onclick="ocultarFormUsuario()">
                            <span>‚ùå</span> Cancelar
                        </button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-bottom: 2rem;">
                    <button class="btn btn-secondary" onclick="mostrarFormUsuario()">
                        <span>‚ûï</span> Agregar Nuevo Usuario
                    </button>
                </div>
                
                <div class="card-header">
                    <h2 class="card-title"><i>üë•</i> Lista de Usuarios</h2>
                    <p class="card-description">Total de usuarios registrados: <span id="totalUsuariosLista">0</span></p>
                </div>
                
                <div class="search-container" style="margin-bottom: 1.5rem;">
                    <input type="text" id="searchUser" class="form-control" placeholder="üîç Buscar usuario por nombre o email..." onkeyup="filtrarUsuarios()">
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Rol</th>
                                <th>Carrera</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- LIBROS -->
        <section id="libros" class="content-section">
            <div class="section-header">
                <h1 class="section-title">üìö Gesti√≥n de Libros</h1>
                <p class="section-subtitle">Administraci√≥n del cat√°logo completo de libros disponibles en la biblioteca digital.</p>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i>‚ûï</i> Agregar Nuevo Libro</h2>
                    <p class="card-description">Complete el formulario para agregar un nuevo libro al cat√°logo.</p>
                </div>
                
                <div id="formLibro" class="form-container" style="display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>T√≠tulo del Libro</label>
                            <input type="text" id="tituloLibro" class="form-control" placeholder="Ej: 1984">
                        </div>
                        <div class="form-group">
                            <label>Autor</label>
                            <input type="text" id="autorLibro" class="form-control" placeholder="Ej: George Orwell">
                        </div>
                        <div class="form-group">
                            <label>A√±o de Publicaci√≥n</label>
                            <input type="number" id="anoLibro" class="form-control" placeholder="Ej: 1949" min="1000" max="2025">
                        </div>
                        <div class="form-group">
                            <label>Categor√≠a</label>
                            <input type="text" id="categoriaLibro" class="form-control" placeholder="Ej: Distop√≠a">
                        </div>

                        <div class="form-group">
                            <label>Carrera</label>
                            <input type="text" id="carreraLibro" class="form-control" placeholder="Ej: Ingenier√≠a en Inform√°tica">
                            </div>

                        <div class="form-group">
                            <label>ISBN</label>
                            <input type="text" id="isbnLibro" class="form-control" placeholder="Ej: 9780451524935">
                        </div>
                        <div class="form-group">
                            <label>URL de Imagen</label>
                            <input type="text" id="imagenLibro" class="form-control" placeholder="Ej: img/libro.jpg">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea id="descripcionLibro" class="form-control" rows="4" placeholder="Descripci√≥n detallada del libro..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-success" onclick="guardarLibro()">
                            <span>üíæ</span> Guardar Libro
                        </button>
                        <button class="btn btn-outline" onclick="ocultarFormLibro()">
                            <span>‚ùå</span> Cancelar
                        </button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-bottom: 2rem;">
                    <button class="btn btn-secondary" onclick="mostrarFormLibro()">
                        <span>‚ûï</span> Agregar Nuevo Libro
                    </button>
                </div>
                
                <div class="card-header">
                    <h2 class="card-title"><i>üìö</i> Cat√°logo de Libros</h2>
                    <p class="card-description">Total de libros en cat√°logo: <span id="totalLibrosLista">0</span></p>
                </div>
                
                <div class="search-container" style="margin-bottom: 1.5rem;">
                    <input type="text" id="searchBook" class="form-control" placeholder="üîç Buscar libro por t√≠tulo o autor..." onkeyup="filtrarLibros()">
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>T√≠tulo</th>
                                <th>Autor</th>
                                <th>A√±o</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="booksTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- AUDITOR√çAS -->
        <section id="auditorias" class="content-section">
            <div class="section-header">
                <h1 class="section-title">üîê Auditor√≠as del Sistema</h1>
                <p class="section-subtitle">Registro completo de todas las actividades y eventos importantes del sistema.</p>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i>üìã</i> Registro de Actividades</h2>
                    <p class="card-description">Total de registros de auditor√≠a: <span id="totalAuditorias">0</span></p>
                </div>
                
                <div class="export-container">
                    <button class="btn btn-primary" onclick="exportAuditoriasPDF()">
                        <span>üìÑ</span> Exportar a PDF
                    </button>
                    <button class="btn btn-success" onclick="exportAuditoriasExcel()">
                        <span>üìä</span> Exportar a Excel
                    </button>
                    <select id="filterAuditoria" class="form-control" style="width: auto;" onchange="filtrarAuditorias()">
                        <option value="todos">üìã Todos los registros</option>
                        <option value="login">üîë Inicios de sesi√≥n</option>
                        <option value="prestamo">üìñ Pr√©stamos</option>
                        <option value="devolucion">‚Ü©Ô∏è Devoluciones</option>
                        <option value="usuario">üë• Gesti√≥n de usuarios</option>
                        <option value="libro">üìö Gesti√≥n de libros</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>IP</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="auditTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PR√âSTAMOS -->
        <section id="prestamos" class="content-section">
            <div class="section-header">
                <h1 class="section-title">üìñ Estado de Pr√©stamos</h1>
                <p class="section-subtitle">Visi√≥n general de todos los pr√©stamos activos, atrasados y devueltos en el sistema.</p>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i>üìä</i> Resumen de Pr√©stamos</h2>
                    <p class="card-description">Distribuci√≥n actual de los pr√©stamos en el sistema.</p>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Libro</th>
                                <th>Usuario</th>
                                <th>Fecha Pr√©stamo</th>
                                <th>Fecha L√≠mite</th>
                                <th>Estado</th>
                                <th>Multa</th>
                            </tr>
                        </thead>
                        <tbody id="loanTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- REPORTES -->
        <section id="reportes" class="content-section">
    <div class="section-header">
        <h1 class="section-title">üìà Reportes y Estad√≠sticas</h1>
        <p class="section-subtitle">Generaci√≥n de reportes detallados y an√°lisis estad√≠sticos del sistema.</p>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title"><i>üìä</i> Estad√≠sticas Generales</h2>
            <p class="card-description">An√°lisis visual del estado general del sistema de biblioteca.</p>
        </div>
        
        <div class="chart-container">
            <canvas id="chartEstadisticas"></canvas>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title"><i>üìã</i> Generar Reportes</h2>
            <p class="card-description">Seleccione el tipo de reporte que desea visualizar.</p>
        </div>
        
        <!-- Agregar aqu√≠ el contenido adicional para generar reportes -->
    </div>
</section>

<!-- Incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('chartEstadisticas').getContext('2d');
    
    // Datos de estad√≠sticas generales
    const data = {
        labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
        datasets: [
            {
                label: 'Pr√©stamos',
                data: [120, 150, 180, 140, 200, 170],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                tension: 0.4
            },
            {
                label: 'Devoluciones',
                data: [110, 140, 160, 130, 180, 155],
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                tension: 0.4
            },
            {
                label: 'Nuevos Usuarios',
                data: [30, 45, 50, 35, 55, 40],
                backgroundColor: 'rgba(255, 159, 64, 0.5)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 2,
                tension: 0.4
            }
        ]
    };

    // Configuraci√≥n del gr√°fico
    const config = {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Biblioteca Digital - Estad√≠sticas Generales'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Meses'
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Cantidad'
                    },
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'nearest'
            },
            elements: {
                point: {
                    radius: 4,
                    hoverRadius: 7
                }
            }
        }
    };

    // Crear el gr√°fico
    new Chart(ctx, config);
});
</script>

<style>
.content-section {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.section-header {
    text-align: center;
    margin-bottom: 40px;
}

.section-title {
    font-size: 2.2rem;
    color: #2c3e50;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.section-subtitle {
    color: #7f8c8d;
    font-size: 1.1rem;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.5;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    margin-bottom: 30px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.card-header {
    padding: 24px 30px 0 30px;
    border-bottom: 1px solid #eee;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.card-title {
    font-size: 1.5rem;
    color: #2c3e50;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.card-title i {
    font-size: 1.3em;
}

.card-description {
    color: #7f8c8d;
    margin-bottom: 20px;
    font-size: 0.95rem;
    line-height: 1.5;
}

.chart-container {
    position: relative;
    height: 450px;
    padding: 25px;
}

/* Responsive */
@media (max-width: 768px) {
    .content-section {
        padding: 15px;
    }
    
    .section-title {
        font-size: 1.8rem;
    }
    
    .chart-container {
        height: 350px;
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .section-title {
        font-size: 1.5rem;
    }
    
    .chart-container {
        height: 300px;
    }
}
</style>
                
                <div class="export-container">
                    <button class="btn btn-primary" onclick="generarReportePrestamos()">
                        <span>üìÑ</span> Reporte de Pr√©stamos
                    </button>
                    <button class="btn btn-secondary" onclick="generarReporteLibros()">
                        <span>üìö</span> Reporte de Libros
                    </button>
                    <button class="btn btn-success" onclick="generarReporteUsuarios()">
                        <span>üë•</span> Reporte de Usuarios
                    </button>
                    <button class="btn btn-danger" onclick="generarReporteMultas()">
                        <span>üí∞</span> Reporte de Multas
                    </button>
                </div>
            </div>
        </section>
    </main>
</div>

<script>
// Datos del administrador actual
let currentUser = JSON.parse(localStorage.getItem('currentUser'));

// Funciones principales
function showSection(id, element) {
    // Remover active de todas las secciones
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    
    // Agregar active a la secci√≥n seleccionada
    document.getElementById(id).classList.add('active');
    element.classList.add('active');
    
    // Actualizar la secci√≥n mostrada
    if(id === 'dashboard') actualizarDashboard();
    else if(id === 'usuarios') cargarUsuarios();
    else if(id === 'libros') cargarLibros();
    else if(id === 'auditorias') cargarAuditorias();
    else if(id === 'prestamos') cargarPrestamos();
    else if(id === 'reportes') cargarReportes();
}

// üìä DASHBOARD
function actualizarDashboard() {
    // Estad√≠sticas
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const books = JSON.parse(localStorage.getItem('books')) || [];
    const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
    const multas = JSON.parse(localStorage.getItem('multas')) || [];
    
    document.getElementById('totalUsuarios').textContent = users.length;
    document.getElementById('totalLibros').textContent = books.length;
    document.getElementById('prestamosActivos').textContent = prestamos.filter(p => p.estado === 'activo' || p.estado === 'atrasado').length;
    document.getElementById('multasPendientes').textContent = multas.filter(m => m.estado === 'pendiente').length;
    
    // Gr√°fico de pr√©stamos
    const ctx = document.getElementById('chartPrestamos').getContext('2d');
    const prestamosActivos = prestamos.filter(p => p.estado === 'activo').length;
    const prestamosAtrasados = prestamos.filter(p => p.estado === 'atrasado').length;
    const prestamosDevueltos = prestamos.filter(p => p.estado === 'devuelto').length;
    
    if(window.chartPrestamos) window.chartPrestamos.destroy();
    
    window.chartPrestamos = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['üìñ Activos', '‚ö†Ô∏è Atrasados', '‚úÖ Devueltos'],
            datasets: [{
                data: [prestamosActivos, prestamosAtrasados, prestamosDevueltos],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(59, 130, 246, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(239, 68, 68, 1)',
                    'rgba(59, 130, 246, 1)'
                ],
                borderWidth: 2,
                hoverOffset: 20
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'right',
                    labels: {
                        padding: 20,
                        font: {
                            size: 14,
                            family: "'Segoe UI', sans-serif"
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 14 },
                    bodyFont: { size: 14 },
                    padding: 12
                }
            },
            cutout: '60%',
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
}

// üë• GESTI√ìN DE USUARIOS
function mostrarFormUsuario() {
    document.getElementById('formUsuario').style.display = 'block';
}

function ocultarFormUsuario() {
    document.getElementById('formUsuario').style.display = 'none';
    // Limpiar campos
    document.getElementById('nombreUsuario').value = '';
    document.getElementById('emailUsuario').value = '';
    document.getElementById('rolUsuario').value = 'estudiante';
    document.getElementById('carreraUsuario').value = '';
    document.getElementById('usernameUsuario').value = '';
    document.getElementById('passwordUsuario').value = '';
}

function guardarUsuario() {
    const nombre = document.getElementById('nombreUsuario').value;
    const email = document.getElementById('emailUsuario').value;
    const rol = document.getElementById('rolUsuario').value;
    const carrera = document.getElementById('carreraUsuario').value;
    const username = document.getElementById('usernameUsuario').value;
    const password = document.getElementById('passwordUsuario').value;

    if(!nombre || !email || !username || !password) {
        alert('‚ùå Por favor complete todos los campos requeridos.');
        return;
    }

    // üîê Validaci√≥n contrase√±a segura
    const regexPassword = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-={}[\]|:;"'<>,.?/~`]).{8,}$/;

    if (!regexPassword.test(password)) {
        alert('‚ö† La contrase√±a debe incluir: \n- May√∫sculas \n- Min√∫sculas \n- N√∫meros \n- Caracteres especiales \n- Al menos 8 caracteres');
        return;
    }

    let users = JSON.parse(localStorage.getItem('users')) || [];

    // Verificar si el usuario ya existe
    if(users.find(u => u.username === username)) {
        alert('‚ùå El nombre de usuario ya existe.');
        return;
    }

    // Crear nuevo usuario
    const nuevoUsuario = {
        id: Date.now(),
        name: nombre,
        email: email,
        username: username,
        password: password,
        role: rol,
        career: rol === 'estudiante' ? carrera : null,
        fechaRegistro: new Date().toLocaleString()
    };

    users.push(nuevoUsuario);
    localStorage.setItem('users', JSON.stringify(users));

    // Registrar auditor√≠a
    registrarAuditoria(currentUser.name, `Creaci√≥n de usuario: ${nombre} (${rol})`);

    alert('‚úÖ Usuario creado exitosamente.');
    ocultarFormUsuario();
    cargarUsuarios();
    actualizarDashboard();
}


function cargarUsuarios() {
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const container = document.getElementById('usersTable');
    
    document.getElementById('totalUsuariosLista').textContent = users.length;
    
    if(users.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="5">
                    <div class="empty-state">
                        <div>üë•</div>
                        <h3>No hay usuarios registrados</h3>
                        <p>Comience agregando nuevos usuarios al sistema</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    container.innerHTML = users.map(u => {
        const rolIcon = u.role === 'estudiante' ? 'üë®‚Äçüéì' : 
                       u.role === 'bibliotecario' ? 'üë©‚Äçüíº' : 'üë®‚Äçüíº';
        const rolColor = u.role === 'estudiante' ? 'badge-success' : 
                        u.role === 'bibliotecario' ? 'badge-warning' : 'badge-danger';
        
        return `
            <tr>
                <td><strong>${u.name}</strong></td>
                <td>${u.email}</td>
                <td><span class="badge ${rolColor}">${rolIcon} ${u.role}</span></td>
                <td>${u.career || '-'}</td>
                <td>
                    <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="editarUsuario(${u.id})">
                        <span>‚úèÔ∏è</span> Editar
                    </button>
                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.85rem; margin-left: 0.5rem;" onclick="eliminarUsuario(${u.id})">
                        <span>üóëÔ∏è</span> Eliminar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filtrarUsuarios() {
    const search = document.getElementById('searchUser').value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    });
}

function editarUsuario(id) {
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const usuario = users.find(u => u.id === id);
    
    if(!usuario) {
        alert('‚ùå Usuario no encontrado.');
        return;
    }
    
    // Llenar el formulario con datos del usuario
    document.getElementById('nombreUsuario').value = usuario.name;
    document.getElementById('emailUsuario').value = usuario.email;
    document.getElementById('rolUsuario').value = usuario.role;
    document.getElementById('carreraUsuario').value = usuario.career || '';
    document.getElementById('usernameUsuario').value = usuario.username;
    document.getElementById('passwordUsuario').value = usuario.password;
    
    // Mostrar formulario
    document.getElementById('formUsuario').style.display = 'block';
    
    // Cambiar comportamiento del bot√≥n guardar
    const guardarBtn = document.querySelector('#formUsuario .btn-success');
    guardarBtn.innerHTML = '<span>‚úèÔ∏è</span> Actualizar Usuario';
    guardarBtn.onclick = function() { actualizarUsuario(id); };
    
    // Registrar auditor√≠a
    registrarAuditoria(currentUser.name, `Inici√≥ edici√≥n de usuario: ${usuario.name}`);
}

function actualizarUsuario(id) {
    const nombre = document.getElementById('nombreUsuario').value;
    const email = document.getElementById('emailUsuario').value;
    const rol = document.getElementById('rolUsuario').value;
    const carrera = document.getElementById('carreraUsuario').value;
    const username = document.getElementById('usernameUsuario').value;
    const password = document.getElementById('passwordUsuario').value;
    
    if(!nombre || !email || !username || !password) {
        alert('‚ùå Por favor complete todos los campos requeridos.');
        return;
    }
    
    let users = JSON.parse(localStorage.getItem('users')) || [];
    const usuarioIndex = users.findIndex(u => u.id === id);
    
    if(usuarioIndex === -1) {
        alert('‚ùå Usuario no encontrado.');
        return;
    }
    
    // Verificar si el nombre de usuario ya existe (excepto para este usuario)
    const usuarioExistente = users.find(u => u.username === username && u.id !== id);
    if(usuarioExistente) {
        alert('‚ùå El nombre de usuario ya existe.');
        return;
    }
    
    // Actualizar usuario
    users[usuarioIndex] = {
        ...users[usuarioIndex],
        name: nombre,
        email: email,
        username: username,
        password: password,
        role: rol,
        career: rol === 'estudiante' ? carrera : null,
        fechaActualizacion: new Date().toLocaleString()
    };
    
    localStorage.setItem('users', JSON.stringify(users));
    
    // Registrar auditor√≠a
    registrarAuditoria(currentUser.name, `Actualizaci√≥n de usuario: ${nombre} (${rol})`);
    
    alert('‚úÖ Usuario actualizado exitosamente.');
    ocultarFormUsuario();
    cargarUsuarios();
    actualizarDashboard();
}

function eliminarUsuario(id) {
    if(!confirm('‚ö†Ô∏è ¬øEst√° seguro de eliminar este usuario?\nEsta acci√≥n no se puede deshacer.')) return;
    
    let users = JSON.parse(localStorage.getItem('users')) || [];
    const usuario = users.find(u => u.id === id);
    
    if(!usuario) {
        alert('‚ùå Usuario no encontrado.');
        return;
    }
    
    // Verificar si el usuario tiene pr√©stamos activos
    const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
    const tienePrestamos = prestamos.some(p => p.estudianteId === id && (p.estado === 'activo' || p.estado === 'atrasado'));
    
    if(tienePrestamos) {
        alert('‚ùå No se puede eliminar el usuario porque tiene pr√©stamos activos.');
        return;
    }
    
    users = users.filter(u => u.id !== id);
    localStorage.setItem('users', JSON.stringify(users));
    
    // Registrar auditor√≠a
    registrarAuditoria(currentUser.name, `Eliminaci√≥n de usuario: ${usuario.name}`);
    
    alert('‚úÖ Usuario eliminado exitosamente.');
    cargarUsuarios();
    actualizarDashboard();
}

// üìö GESTI√ìN DE LIBROS
function mostrarFormLibro() {
    document.getElementById('formLibro').style.display = 'block';
}

function ocultarFormLibro() {
    document.getElementById('formLibro').style.display = 'none';
    // Limpiar campos
    document.getElementById('tituloLibro').value = '';
    document.getElementById('autorLibro').value = '';
    document.getElementById('anoLibro').value = '';
    document.getElementById('categoriaLibro').value = '';
    document.getElementById('carreraLibro').value = ''; // Nuevo campo
    document.getElementById('isbnLibro').value = '';
    document.getElementById('descripcionLibro').value = '';
    document.getElementById('imagenLibro').value = '';
}

function guardarLibro() {
    const titulo = document.getElementById('tituloLibro').value;
    const autor = document.getElementById('autorLibro').value;
    const ano = document.getElementById('anoLibro').value;
    const categoria = document.getElementById('categoriaLibro').value;
    const carrera = document.getElementById('carreraLibro').value; // Nuevo campo
    const isbn = document.getElementById('isbnLibro').value;
    const descripcion = document.getElementById('descripcionLibro').value;
    const imagen = document.getElementById('imagenLibro').value;
    
    if(!titulo || !autor) {
        alert('‚ùå Por favor complete t√≠tulo y autor.');
        return;
    }
    
    let books = JSON.parse(localStorage.getItem('books')) || [];
    
    // Verificar si el ISBN ya existe
    if(isbn && books.find(b => b.isbn === isbn)) {
        alert('‚ùå Ya existe un libro con este ISBN.');
        return;
    }
    
    // Crear nuevo libro
    const nuevoLibro = {
        id: Date.now(),
        title: titulo,
        author: autor,
        year: parseInt(ano) || new Date().getFullYear(),
        category: categoria,
        carrera: carrera, // Nuevo campo
        description: descripcion,
        img: imagen || 'img/book-placeholder.png',
        isbn: isbn,
        available: true,
        fechaRegistro: new Date().toLocaleString()
    };
    
    books.push(nuevoLibro);
    localStorage.setItem('books', JSON.stringify(books));
    
    // Registrar auditor√≠a
    registrarAuditoria(currentUser.name, `Creaci√≥n de libro: ${titulo}`);
    
    alert('‚úÖ Libro creado exitosamente.');
    ocultarFormLibro();
    cargarLibros();
    actualizarDashboard();
}

function cargarLibros() {
    const books = JSON.parse(localStorage.getItem('books')) || [];
    const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
    const container = document.getElementById('booksTable');
    
    document.getElementById('totalLibrosLista').textContent = books.length;
    
    if(books.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <div>üìö</div>
                        <h3>No hay libros en el cat√°logo</h3>
                        <p>Comience agregando nuevos libros al sistema</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    container.innerHTML = books.map(b => {
        const prestado = prestamos.some(p => p.libroId === b.id && (p.estado === 'activo' || p.estado === 'atrasado'));
        const estado = prestado ? 'Prestado' : (b.available ? 'Disponible' : 'No disponible');
        const estadoClass = prestado ? 'badge-warning' : (b.available ? 'badge-success' : 'badge-danger');
        
        return `
            <tr>
                <td><img src="${b.img || 'img/book-placeholder.png'}" class="book-img" alt="${b.title}"></td>
                <td><strong>${b.title}</strong><br><small>${b.category || 'Sin categor√≠a'}</small></td>
                <td>${b.author}</td>
                <td>${b.year}</td>
                <td><span class="badge ${estadoClass}">${estado}</span></td>
                <td>
                    <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="editarLibro(${b.id})">
                        <span>‚úèÔ∏è</span> Editar
                    </button>
                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.85rem; margin-left: 0.5rem;" onclick="eliminarLibro(${b.id})">
                        <span>üóëÔ∏è</span> Eliminar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filtrarLibros() {
    const search = document.getElementById('searchBook').value.toLowerCase();
    const rows = document.querySelectorAll('#booksTable tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    });
}

function editarLibro(id) {
    const books = JSON.parse(localStorage.getItem('books')) || [];
    const libro = books.find(b => b.id === id);
    
    if(!libro) {
        alert('‚ùå Libro no encontrado.');
        return;
    }
    
    // Llenar el formulario con datos del libro
    document.getElementById('tituloLibro').value = libro.title;
    document.getElementById('autorLibro').value = libro.author;
    document.getElementById('anoLibro').value = libro.year;
    document.getElementById('categoriaLibro').value = libro.category || '';
    document.getElementById('carreraLibro').value = libro.carrera || ''; // Nuevo campo
    document.getElementById('isbnLibro').value = libro.isbn || '';
    document.getElementById('descripcionLibro').value = libro.description || '';
    document.getElementById('imagenLibro').value = libro.img || '';
    
    // Mostrar formulario
    document.getElementById('formLibro').style.display = 'block';
    
    // Cambiar comportamiento del bot√≥n guardar
    const guardarBtn = document.querySelector('#formLibro .btn-success');
    guardarBtn.innerHTML = '<span>‚úèÔ∏è</span> Actualizar Libro';
    guardarBtn.onclick = function() { actualizarLibro(id); };
    
    // Registrar auditor√≠a
    registrarAuditoria(currentUser.name, `Inici√≥ edici√≥n de libro: ${libro.title}`);
}

function actualizarLibro(id) {
    const titulo = document.getElementById('tituloLibro').value;
    const autor = document.getElementById('autorLibro').value;
    const ano = document.getElementById('anoLibro').value;
    const categoria = document.getElementById('categoriaLibro').value;
    const carrera = document.getElementById('carreraLibro').value; // Nuevo campo
    const isbn = document.getElementById('isbnLibro').value;
    const descripcion = document.getElementById('descripcionLibro').value;
    const imagen = document.getElementById('imagenLibro').value;
    
    if(!titulo || !autor) {
        alert('‚ùå Por favor complete t√≠tulo y autor.');
        return;
    }
    
    let books = JSON.parse(localStorage.getItem('books')) || [];
    const libroIndex = books.findIndex(b => b.id === id);
    
    if(libroIndex === -1) {
        alert('‚ùå Libro no encontrado.');
        return;
    }
    
    // Verificar si el ISBN ya existe (excepto para este libro)
    if(isbn && books.find(b => b.isbn === isbn && b.id !== id)) {
        alert('‚ùå Ya existe un libro con este ISBN.');
        return;
    }
    
    // Actualizar libro
    books[libroIndex] = {
        ...books[libroIndex],
        title: titulo,
        author: autor,
        year: parseInt(ano) || new Date().getFullYear(),
        category: categoria,
        carrera: carrera, // Nuevo campo
        description: descripcion,
        img: imagen || 'img/book-placeholder.png',
        isbn: isbn,
        fechaActualizacion: new Date().toLocaleString()
    };
    
    localStorage.setItem('books', JSON.stringify(books));
    
    // Registrar auditor√≠a
    registrarAuditoria(currentUser.name, `Actualizaci√≥n de libro: ${titulo}`);
    
    alert('‚úÖ Libro actualizado exitosamente.');
    ocultarFormLibro();
    cargarLibros();
    actualizarDashboard();
}

function eliminarLibro(id) {
    if(!confirm('‚ö†Ô∏è ¬øEst√° seguro de eliminar este libro?\nEsta acci√≥n no se puede deshacer.')) return;
    
    let books = JSON.parse(localStorage.getItem('books')) || [];
    const libro = books.find(b => b.id === id);
    
    if(!libro) {
        alert('‚ùå Libro no encontrado.');
        return;
    }
    
    // Verificar si el libro est√° prestado
    const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
    const prestado = prestamos.some(p => p.libroId === id && (p.estado === 'activo' || p.estado === 'atrasado'));
    
    if(prestado) {
        alert('‚ùå No se puede eliminar el libro porque est√° prestado.');
        return;
    }
    
    books = books.filter(b => b.id !== id);
    localStorage.setItem('books', JSON.stringify(books));
    
    // Registrar auditor√≠a
    registrarAuditoria(currentUser.name, `Eliminaci√≥n de libro: ${libro.title}`);
    
    alert('‚úÖ Libro eliminado exitosamente.');
    cargarLibros();
    actualizarDashboard();
}

// üîê AUDITOR√çAS
function cargarAuditorias() {
    let auditorias = JSON.parse(localStorage.getItem('auditorias')) || [];
    const container = document.getElementById('auditTable');
    
    document.getElementById('totalAuditorias').textContent = auditorias.length;
    
    // Si no hay auditor√≠as, crear algunas de ejemplo
    if(auditorias.length === 0) {
        auditorias = [
            {usuario:'Admin Sistema', fecha:'01-12-2025', hora:'10:30:25', ip:'192.168.1.100', accion:'Inicio de sesi√≥n', tipo:'login'},
            {usuario:'Juan P√©rez', fecha:'01-12-2025', hora:'11:15:42', ip:'192.168.1.150', accion:'Solicitud de pr√©stamo - 1984', tipo:'prestamo'},
            {usuario:'Mar√≠a Rodr√≠guez', fecha:'01-12-2025', hora:'11:30:10', ip:'192.168.1.200', accion:'Aprobaci√≥n de pr√©stamo', tipo:'prestamo'},
            {usuario:'Juan P√©rez', fecha:'30-11-2025', hora:'14:20:15', ip:'192.168.1.150', accion:'Devoluci√≥n de libro', tipo:'devolucion'},
            {usuario:'Admin Sistema', fecha:'30-11-2025', hora:'16:45:30', ip:'192.168.1.100', accion:'Generaci√≥n de reporte', tipo:'reporte'},
            {usuario:'Admin Sistema', fecha:'30-11-2025', hora:'09:15:20', ip:'192.168.1.100', accion:'Creaci√≥n de usuario: Carlos L√≥pez', tipo:'usuario'},
            {usuario:'Admin Sistema', fecha:'29-11-2025', hora:'15:40:10', ip:'192.168.1.100', accion:'Actualizaci√≥n de libro: Don Quijote', tipo:'libro'}
        ];
        localStorage.setItem('auditorias', JSON.stringify(auditorias));
    }
    
    // Ordenar por fecha (m√°s recientes primero)
    auditorias.sort((a,b) => {
        const dateA = new Date(a.fecha.split('-').reverse().join('-') + ' ' + a.hora);
        const dateB = new Date(b.fecha.split('-').reverse().join('-') + ' ' + b.hora);
        return dateB - dateA;
    });
    
    if(auditorias.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="5">
                    <div class="empty-state">
                        <div>üîê</div>
                        <h3>No hay registros de auditor√≠a</h3>
                        <p>Las actividades del sistema aparecer√°n aqu√≠</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    container.innerHTML = auditorias.map(a => {
        const tipoIcon = a.tipo === 'login' ? 'üîë' : 
                        a.tipo === 'prestamo' ? 'üìñ' : 
                        a.tipo === 'devolucion' ? '‚Ü©Ô∏è' : 
                        a.tipo === 'usuario' ? 'üë•' : 
                        a.tipo === 'libro' ? 'üìö' : 'üìä';
        
        return `
            <tr>
                <td><strong>${a.usuario}</strong></td>
                <td>${a.fecha}</td>
                <td>${a.hora}</td>
                <td><code>${a.ip}</code></td>
                <td>${tipoIcon} ${a.accion}</td>
            </tr>
        `;
    }).join('');
}

function filtrarAuditorias() {
    const filter = document.getElementById('filterAuditoria').value;
    const rows = document.querySelectorAll('#auditTable tr');
    
    rows.forEach(row => {
        const text = row.textContent;
        let show = true;
        
        if(filter !== 'todos') {
            if(filter === 'login') show = text.includes('üîë');
            else if(filter === 'prestamo') show = text.includes('üìñ');
            else if(filter === 'devolucion') show = text.includes('‚Ü©Ô∏è');
            else if(filter === 'usuario') show = text.includes('üë•');
            else if(filter === 'libro') show = text.includes('üìö');
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// Registrar nueva auditor√≠a
function registrarAuditoria(usuario, accion) {
    let auditorias = JSON.parse(localStorage.getItem('auditorias')) || [];
    const fecha = new Date();
    
    auditorias.push({
        usuario: usuario,
        fecha: fecha.toLocaleDateString('es-CL'),
        hora: fecha.toLocaleTimeString('es-CL'),
        ip: '192.168.' + Math.floor(Math.random() * 255) + '.' + Math.floor(Math.random() * 255),
        accion: accion,
        tipo: accion.includes('sesi√≥n') ? 'login' : 
              accion.includes('pr√©stamo') || accion.includes('Prestamo') ? 'prestamo' : 
              accion.includes('devoluci√≥n') || accion.includes('Devoluci√≥n') ? 'devolucion' : 
              accion.includes('usuario') || accion.includes('Usuario') ? 'usuario' : 
              accion.includes('libro') || accion.includes('Libro') ? 'libro' : 'otro'
    });
    
    localStorage.setItem('auditorias', JSON.stringify(auditorias));
}

// üìñ PR√âSTAMOS
function cargarPrestamos() {
    const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
    const books = JSON.parse(localStorage.getItem('books')) || [];
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const container = document.getElementById('loanTable');
    
    if(prestamos.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <div>üìñ</div>
                        <h3>No hay pr√©stamos registrados</h3>
                        <p>Los pr√©stamos activos aparecer√°n aqu√≠</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    container.innerHTML = prestamos.map(p => {
        const libro = books.find(b => b.id === p.libroId);
        const usuario = users.find(u => u.id === p.estudianteId);
        const hoy = new Date();
        const fechaLimite = new Date(p.fechaDevolucion);
        const atrasado = hoy > fechaLimite && (p.estado === 'activo' || p.estado === 'atrasado');
        const diasAtraso = atrasado ? Math.floor((hoy - fechaLimite) / (1000 * 60 * 60 * 24)) : 0;
        const multa = atrasado ? diasAtraso * 1000 : 0;
        
        const estadoClass = p.estado === 'activo' ? 'badge-success' : 
                           p.estado === 'atrasado' ? 'badge-danger' : 'badge-info';
        const estadoText = p.estado === 'activo' ? 'ACTIVO' : 
                          p.estado === 'atrasado' ? 'ATRASADO' : 'DEVUELTO';
        
        return `
            <tr>
                <td><strong>${libro ? libro.title : 'Libro no encontrado'}</strong><br><small>${libro ? libro.author : 'N/A'}</small></td>
                <td>${usuario ? usuario.name : 'Usuario no encontrado'}</td>
                <td>${p.fechaPrestamo}</td>
                <td>${p.fechaDevolucion}</td>
                <td><span class="badge ${estadoClass}">${estadoText}</span></td>
                <td>${atrasado ? `<strong style="color:var(--danger);">$${multa}</strong>` : '-'}</td>
            </tr>
        `;
    }).join('');
}

// üìà REPORTES
function cargarReportes() {
    const books = JSON.parse(localStorage.getItem('books')) || [];
    const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const multas = JSON.parse(localStorage.getItem('multas')) || [];
    
    // Gr√°fico de estad√≠sticas
    const ctx = document.getElementById('chartEstadisticas').getContext('2d');
    const estudiantes = users.filter(u => u.role === 'estudiante').length;
    const bibliotecarios = users.filter(u => u.role === 'bibliotecario').length;
    const administradores = users.filter(u => u.role === 'administrador').length;
    const librosDisponibles = books.filter(b => b.available).length;
    const librosPrestados = books.length - librosDisponibles;
    const prestamosActivos = prestamos.filter(p => p.estado === 'activo').length;
    const prestamosAtrasados = prestamos.filter(p => p.estado === 'atrasado').length;
    const multasPendientes = multas.filter(m => m.estado === 'pendiente').length;
    const multasPagadas = multas.filter(m => m.estado === 'pagada').length;
    
    if(window.chartEstadisticas) window.chartEstadisticas.destroy();
    
    window.chartEstadisticas = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['üë• Estudiantes', 'üë©‚Äçüíº Bibliotecarios', 'üë®‚Äçüíº Admins', 'üìö Libros Disponibles', 'üìñ Libros Prestados', '‚úÖ Pr√©stamos Activos', '‚ö†Ô∏è Pr√©stamos Atrasados', 'üí∞ Multas Pendientes', 'üíµ Multas Pagadas'],
            datasets: [{
                label: 'Cantidad',
                data: [estudiantes, bibliotecarios, administradores, librosDisponibles, librosPrestados, prestamosActivos, prestamosAtrasados, multasPendientes, multasPagadas],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(249, 115, 22, 0.8)',
                    'rgba(220, 38, 38, 0.8)',
                    'rgba(22, 163, 74, 0.8)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(16, 185, 129, 1)',
                    'rgba(139, 92, 246, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(239, 68, 68, 1)',
                    'rgba(34, 197, 94, 1)',
                    'rgba(249, 115, 22, 1)',
                    'rgba(220, 38, 38, 1)',
                    'rgba(22, 163, 74, 1)'
                ],
                borderWidth: 2,
                borderRadius: 8,
                hoverBackgroundColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(16, 185, 129, 1)',
                    'rgba(139, 92, 246, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(239, 68, 68, 1)',
                    'rgba(34, 197, 94, 1)',
                    'rgba(249, 115, 22, 1)',
                    'rgba(220, 38, 38, 1)',
                    'rgba(22, 163, 74, 1)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'üìä Estad√≠sticas Generales del Sistema',
                    font: {
                        size: 18,
                        family: "'Segoe UI', sans-serif",
                        weight: 'bold'
                    },
                    padding: 20
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 14 },
                    bodyFont: { size: 14 },
                    padding: 12,
                    cornerRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        maxRotation: 45
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            }
        }
    });
}

// Exportar auditor√≠as a PDF
function exportAuditoriasPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const auditorias = JSON.parse(localStorage.getItem('auditorias')) || [];
    
    // Encabezado
    doc.setFontSize(24);
    doc.setTextColor(66, 145, 17);
    doc.text('Reporte de Auditor√≠as', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text('Sistema Biblioteca Digital INACAP', 105, 30, { align: 'center' });
    doc.text(`Generado: ${new Date().toLocaleString()}`, 105, 37, { align: 'center' });
    
    // L√≠nea separadora
    doc.setDrawColor(196, 191, 42);
    doc.setLineWidth(1);
    doc.line(20, 45, 190, 45);
    
    // Datos
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    
    let y = 55;
    auditorias.forEach((aud, index) => {
        if(y > 270) {
            doc.addPage();
            y = 20;
        }
        
        doc.setFontSize(10);
        doc.text(`${aud.fecha} ${aud.hora}`, 20, y);
        doc.text(`Usuario: ${aud.usuario}`, 60, y);
        doc.text(`IP: ${aud.ip}`, 120, y);
        doc.text(`Acci√≥n: ${aud.accion}`, 20, y + 7);
        
        y += 18;
    });
    
    // Pie de p√°gina
    doc.setFontSize(10);
    doc.setTextColor(150, 150, 150);
    doc.text(`Total de registros: ${auditorias.length}`, 105, 285, { align: 'center' });
    doc.text('¬© Sistema Biblioteca Digital INACAP', 105, 290, { align: 'center' });
    
    doc.save('auditorias_biblioteca.pdf');
    alert('‚úÖ Reporte PDF generado exitosamente.');
}

// Exportar auditor√≠as a Excel
function exportAuditoriasExcel() {
    const auditorias = JSON.parse(localStorage.getItem('auditorias')) || [];
    const wsData = [
        ['Usuario', 'Fecha', 'Hora', 'IP', 'Acci√≥n'],
        ...auditorias.map(aud => [aud.usuario, aud.fecha, aud.hora, aud.ip, aud.accion])
    ];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    
    // Aplicar estilos
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let R = range.s.r; R <= range.e.r; ++R) {
        for(let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = {c: C, r: R};
            const cell_ref = XLSX.utils.encode_cell(cell_address);
            
            if(!ws[cell_ref]) continue;
            
            if(R === 0) {
                ws[cell_ref].s = {
                    fill: { fgColor: { rgb: "C4BF2A" } },
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    alignment: { horizontal: "center" }
                };
            }
        }
    }
    
    // Ajustar ancho de columnas
    const colWidths = [
        {wch: 25}, // Usuario
        {wch: 12}, // Fecha
        {wch: 12}, // Hora
        {wch: 15}, // IP
        {wch: 50}  // Acci√≥n
    ];
    ws['!cols'] = colWidths;
    
    XLSX.utils.book_append_sheet(wb, ws, 'Auditor√≠as');
    XLSX.writeFile(wb, 'auditorias_biblioteca.xlsx');
    alert('‚úÖ Reporte Excel generado exitosamente.');
}

// Generar reportes
function generarReportePrestamos() {
    const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
    const total = prestamos.length;
    const activos = prestamos.filter(p => p.estado === 'activo').length;
    const atrasados = prestamos.filter(p => p.estado === 'atrasado').length;
    const devueltos = prestamos.filter(p => p.estado === 'devuelto').length;
    
    const mensaje = `üìä **Reporte de Pr√©stamos**\n\n` +
                   `üìñ Total de pr√©stamos: ${total}\n` +
                   `‚úÖ Pr√©stamos activos: ${activos}\n` +
                   `‚ö†Ô∏è Pr√©stamos atrasados: ${atrasados}\n` +
                   `‚Ü©Ô∏è Pr√©stamos devueltos: ${devueltos}\n\n` +
                   `üìÖ Generado: ${new Date().toLocaleString()}`;
    
    alert(mensaje);
}

function generarReporteLibros() {
    const books = JSON.parse(localStorage.getItem('books')) || [];
    const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
    const total = books.length;
    const disponibles = books.filter(b => b.available).length;
    const prestados = books.length - disponibles;
    
    const mensaje = `üìä **Reporte de Libros**\n\n` +
                   `üìö Total de libros: ${total}\n` +
                   `‚úÖ Libros disponibles: ${disponibles}\n` +
                   `üìñ Libros prestados: ${prestados}\n` +
                   `üìà Porcentaje de disponibilidad: ${Math.round((disponibles / total) * 100)}%\n\n` +
                   `üìÖ Generado: ${new Date().toLocaleString()}`;
    
    alert(mensaje);
}

function generarReporteUsuarios() {
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const estudiantes = users.filter(u => u.role === 'estudiante').length;
    const bibliotecarios = users.filter(u => u.role === 'bibliotecario').length;
    const administradores = users.filter(u => u.role === 'administrador').length;
    
    const mensaje = `üìä **Reporte de Usuarios**\n\n` +
                   `üë• Total de usuarios: ${users.length}\n` +
                   `üë®‚Äçüéì Estudiantes: ${estudiantes}\n` +
                   `üë©‚Äçüíº Bibliotecarios: ${bibliotecarios}\n` +
                   `üë®‚Äçüíº Administradores: ${administradores}\n\n` +
                   `üìÖ Generado: ${new Date().toLocaleString()}`;
    
    alert(mensaje);
}

function generarReporteMultas() {
    const multas = JSON.parse(localStorage.getItem('multas')) || [];
    const pendientes = multas.filter(m => m.estado === 'pendiente').length;
    const pagadas = multas.filter(m => m.estado === 'pagada').length;
    const totalPendiente = multas.filter(m => m.estado === 'pendiente').reduce((sum, m) => sum + (m.monto || 0), 0);
    const totalPagado = multas.filter(m => m.estado === 'pagada').reduce((sum, m) => sum + (m.monto || 0), 0);
    
    const mensaje = `üìä **Reporte de Multas**\n\n` +
                   `üí∞ Total de multas: ${multas.length}\n` +
                   `‚è≥ Multas pendientes: ${pendientes}\n` +
                   `‚úÖ Multas pagadas: ${pagadas}\n` +
                   `üíµ Total pendiente: $${totalPendiente}\n` +
                   `üí≥ Total pagado: $${totalPagado}\n\n` +
                   `üìÖ Generado: ${new Date().toLocaleString()}`;
    
    alert(mensaje);
}

// ‚≠ê Actualizar avatar del usuario
function updateUserAvatar() {
    if(currentUser && currentUser.name) {
        const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
        document.getElementById('userAvatar').textContent = initials;
    }
}

// ‚≠ê Logout
function logout() {
    if(confirm('‚ö†Ô∏è ¬øEst√° seguro que desea cerrar sesi√≥n?')) {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
    }
}

// ‚≠ê Inicializaci√≥n
function init() {
    if(!currentUser || currentUser.role !== 'administrador') {
        window.location.href = 'index.html';
        return;
    }
    
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = 'Administrador';
    document.getElementById('lastAccess').textContent = '√öltimo acceso: ' + (localStorage.getItem('lastAccessTime') || 'Ahora');
    
    updateUserAvatar();
    actualizarDashboard();
    cargarUsuarios();
    cargarLibros();
    cargarAuditorias();
    cargarPrestamos();
    cargarReportes();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>