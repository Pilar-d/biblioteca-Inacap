<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M√≥dulo Bibliotecario - Biblioteca Digital INACAP</title>
  <style>
    :root {
      --primary: #c4bf2a;
      --primary-dark: #a8a424;
      --secondary: #429111;
      --secondary-dark: #36770e;
      --danger: #f24949;
      --danger-dark: #d12f2f;
      --warning: #f59e0b;
      --warning-dark: #d97706;
      --success: #10b981;
      --success-dark: #059669;
      --info: #1e90ff;
      --info-dark: #0069d9;
      --light: #f8fafc;
      --dark: #1f2937;
      --gray: #6b7280;
      --gray-light: #e5e7eb;
      --white: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e5e7eb 100%);
      min-height: 100vh;
      color: var(--dark);
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--white) 0%, #f9fafb 100%);
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 2px solid var(--gray-light);
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .logo {
      position: relative;
      width: 90px;
      height: 90px;
    }

    .logo img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary);
      box-shadow: 0 4px 12px rgba(196, 191, 42, 0.2);
      transition: var(--transition);
    }

    .logo:hover img {
      transform: rotate(5deg);
      box-shadow: 0 6px 20px rgba(196, 191, 42, 0.3);
    }

    .header-info h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 0.25rem;
    }

    .header-info small {
      color: var(--gray);
      font-size: 0.9rem;
      background: var(--light);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      border: 1px solid var(--gray-light);
    }

    /* User Info */
    .user-container {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      background: var(--white);
      border-radius: var(--radius);
      border: 1px solid var(--gray-light);
      box-shadow: var(--shadow);
    }

    .user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-weight: 600;
      font-size: 1.2rem;
    }

    .user-details {
      text-align: right;
    }

    .user-name {
      font-weight: 700;
      color: var(--dark);
      font-size: 1.1rem;
    }

    .user-role {
      color: var(--primary);
      font-size: 0.85rem;
      font-weight: 600;
    }

    .last-access {
      font-size: 0.8rem;
      color: var(--gray);
    }

    .logout-btn {
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
      color: var(--white);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(242, 73, 73, 0.2);
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(242, 73, 73, 0.3);
    }

    /* Main Container */
    .main-container {
      display: flex;
      min-height: calc(100vh - 80px);
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: linear-gradient(135deg, var(--white) 0%, #f9fafb 100%);
      padding: 2rem 0;
      box-shadow: 2px 0 15px rgba(0, 0, 0, 0.08);
      border-right: 1px solid var(--gray-light);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .nav-item {
      padding: 1rem 2rem;
      margin: 0 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 500;
      color: var(--gray);
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: var(--light);
      color: var(--primary);
      transform: translateX(5px);
      border-color: var(--gray-light);
    }

    .nav-item.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      box-shadow: 0 4px 12px rgba(196, 191, 42, 0.3);
      border-color: var(--primary);
    }

    .nav-item.active:hover {
      transform: translateX(5px);
      background: linear-gradient(135deg, var(--primary-dark) 0%, #8f8b1e 100%);
    }

    .nav-icon {
      font-size: 1.2rem;
    }

    /* Content */
    .content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .content-section {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .content-section.active {
      display: block;
    }

    /* Section Headers */
    .section-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 1rem;
      position: relative;
      display: inline-block;
    }

    .section-title::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 60px;
      height: 4px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 2px;
    }

    .section-subtitle {
      color: var(--gray);
      font-size: 1rem;
      margin-bottom: 2rem;
      max-width: 800px;
    }

    /* Cards */
    .card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      border: 1px solid var(--gray-light);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .card-description {
      color: var(--gray);
      font-size: 0.95rem;
    }

    /* Search */
    .search-container {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .search-input {
      width: 100%;
      padding: 1rem 1.5rem 1rem 3.5rem;
      border: 2px solid var(--gray-light);
      border-radius: var(--radius);
      font-size: 1rem;
      background: var(--white);
      transition: var(--transition);
      box-shadow: var(--shadow);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(196, 191, 42, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 1.5rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 1.2rem;
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      box-shadow: var(--shadow);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
      color: var(--white);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 145, 17, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: var(--white);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
      color: var(--white);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
      color: var(--white);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
    }

    /* Requests List */
    .requests-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: 500px;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .request-item {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-light);
      transition: var(--transition);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .request-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .request-content {
      flex: 1;
    }

    .request-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .request-details {
      color: var(--gray);
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    .request-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.5rem;
    }

    .request-actions {
      display: flex;
      gap: 0.75rem;
    }

    /* Status Badges */
    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--white);
      display: inline-block;
    }

    .badge-pendiente {
      background: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
    }

    .badge-aprobado {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
    }

    .badge-activo {
      background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
    }

    .badge-atrasado {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
    }

    .badge-devuelto {
      background: linear-gradient(135deg, var(--gray) 0%, #4b5563 100%);
    }

    /* Book Cards */
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .book-card {
      background: var(--white);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid var(--gray-light);
    }

    .book-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }

    .book-image {
      height: 180px;
      overflow: hidden;
    }

    .book-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
    }

    .book-card:hover .book-image img {
      transform: scale(1.05);
    }

    .book-info {
      padding: 1.5rem;
    }

    .book-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .book-details {
      color: var(--gray);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .book-status-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Fines */
    .fines-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .fine-item {
      background: var(--white);
      border-radius: var(--radius-sm);
      padding: 1.25rem;
      border: 1px solid var(--gray-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .fine-item.atrasado {
      border-left: 4px solid var(--danger);
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }

    .fine-content h4 {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.25rem;
    }

    .fine-details {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .fine-amount {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--danger);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--white);
      border-radius: var(--radius);
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--gray-light);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
    }

    .modal-close:hover {
      color: var(--danger);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--gray-light);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(196, 191, 42, 0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    .student-search-results {
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--gray-light);
      border-radius: var(--radius-sm);
      background: var(--white);
    }

    .student-result-item {
      padding: 1rem;
      border-bottom: 1px solid var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
    }

    .student-result-item:hover {
      background: var(--light);
    }

    .student-result-item.selected {
      background: linear-gradient(135deg, rgba(66, 145, 17, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%);
      border-left: 4px solid var(--secondary);
    }

    /* Student Details in Fines */
    .student-info-card {
      background: linear-gradient(135deg, #f0f9ff 0%, #e1f5fe 100%);
      border-radius: var(--radius-sm);
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--info);
    }

    .student-info-card h4 {
      color: var(--info-dark);
      margin-bottom: 0.5rem;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      background: var(--white);
      border-radius: var(--radius);
      border: 2px dashed var(--gray-light);
    }

    .empty-state i {
      font-size: 3rem;
      color: var(--gray-light);
      margin-bottom: 1rem;
    }

    .empty-state h3 {
      color: var(--gray);
      margin-bottom: 0.5rem;
    }

    .empty-state p {
      color: var(--gray);
      font-size: 0.95rem;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--gray);
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .inventory-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        padding: 1rem;
        flex-direction: row;
        overflow-x: auto;
        border-right: none;
        border-bottom: 1px solid var(--gray-light);
      }

      .nav-item {
        flex-shrink: 0;
        margin: 0;
        padding: 0.75rem 1rem;
      }

      .content {
        padding: 1.5rem;
      }

      .header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .user-container {
        width: 100%;
        justify-content: space-between;
      }

      .logo-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .request-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .request-actions {
        width: 100%;
        flex-direction: column;
      }

      .request-actions .btn {
        width: 100%;
        justify-content: center;
      }

      .form-actions {
        flex-direction: column;
      }

      .modal {
        padding: 1.5rem;
        margin: 1rem;
      }
    }

    @media (max-width: 480px) {
      .inventory-grid {
        grid-template-columns: 1fr;
      }

      .nav-item {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
      }

      .section-title {
        font-size: 1.5rem;
      }

      .user-profile {
        flex-direction: column;
        text-align: center;
      }

      .user-details {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo-container">
      <div class="logo">
        <img src="img/inacap-logo.png" alt="Logo INACAP">
      </div>
      <div class="header-info">
        <h3>Sistema de Gesti√≥n de Biblioteca Digital</h3>
        <small>M√≥dulo Bibliotecario</small>
      </div>
    </div>

    <div class="user-container">
      <div class="user-profile">
        <div class="user-avatar" id="userAvatar">B</div>
        <div class="user-details">
          <div class="user-name" id="userName">Bibliotecario</div>
          <div class="user-role" id="userRole">Bibliotecario</div>
          <div class="last-access" id="lastAccess"></div>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <span>üö™</span> Cerrar Sesi√≥n
      </button>
    </div>
  </header>

  <div class="main-container">
    <nav class="sidebar">
      <div class="nav-item active" onclick="showSection('solicitudes', this)">
        <span class="nav-icon">üìù</span>
        <span>Solicitudes Pendientes</span>
      </div>
      <div class="nav-item" onclick="showSection('prestamos', this)">
        <span class="nav-icon">üìö</span>
        <span>Gestionar Pr√©stamos</span>
      </div>
      <div class="nav-item" onclick="showSection('devoluciones', this)">
        <span class="nav-icon">‚Ü©Ô∏è</span>
        <span>Registrar Devoluci√≥n</span>
      </div>
      <div class="nav-item" onclick="showSection('inventario', this)">
        <span class="nav-icon">üìñ</span>
        <span>Inventario de Libros</span>
      </div>
      <div class="nav-item" onclick="showSection('multas', this)">
        <span class="nav-icon">üí∞</span>
        <span>Gesti√≥n de Multas</span>
      </div>
    </nav>

    <main class="content">
      <!-- SOLICITUDES PENDIENTES -->
      <section id="solicitudes" class="content-section active">
        <h1 class="section-title">üìù Solicitudes de Pr√©stamo Pendientes</h1>
        <p class="section-subtitle">Aqu√≠ aparecen las solicitudes que los estudiantes han realizado. Puede <strong>aprobar</strong> (se crea un pr√©stamo por 7 d√≠as) o <strong>rechazar</strong> la solicitud.</p>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Solicitudes en espera</h2>
            <p class="card-description">Total de solicitudes pendientes: <span id="totalSolicitudes">0</span></p>
          </div>
          <div class="requests-list" id="requestsList"></div>
        </div>
      </section>

      <!-- GESTIONAR PR√âSTAMOS -->
      <section id="prestamos" class="content-section">
        <h1 class="section-title">üìö Pr√©stamos Activos</h1>
        <p class="section-subtitle">Gesti√≥n y seguimiento de todos los pr√©stamos activos en el sistema</p>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">B√∫squeda de pr√©stamos</h2>
            <p class="card-description">Busque por estudiante, libro o estado</p>
          </div>
          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchPrestamos" class="search-input" placeholder="Buscar por estudiante, libro o estado..." onkeyup="filtrarPrestamos()">
          </div>
          <div class="requests-list" id="prestamosActivosList"></div>
        </div>
      </section>

      <!-- DEVOLUCIONES -->
      <section id="devoluciones" class="content-section">
        <h1 class="section-title">‚Ü©Ô∏è Registrar Devoluci√≥n</h1>
        <p class="section-subtitle">Seleccione un pr√©stamo activo y m√°rquelo como devuelto. Si est√° fuera de plazo puede generar una multa autom√°ticamente.</p>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Pr√©stamos pendientes de devoluci√≥n</h2>
            <p class="card-description">Total de pr√©stamos activos: <span id="totalPrestamos">0</span></p>
          </div>
          <div class="requests-list" id="devolucionesList"></div>
        </div>
      </section>

      <!-- INVENTARIO -->
      <section id="inventario" class="content-section">
        <h1 class="section-title">üìñ Inventario de Libros</h1>
        <p class="section-subtitle">Gesti√≥n completa del cat√°logo de libros disponibles en la biblioteca</p>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">B√∫squeda en inventario</h2>
            <p class="card-description">Busque libros por t√≠tulo, autor, categor√≠a o ISBN</p>
          </div>
          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInventario" class="search-input" placeholder="Buscar por t√≠tulo, autor, categor√≠a o ISBN..." onkeyup="renderInventario()">
          </div>
          <div class="inventory-grid" id="inventarioList"></div>
        </div>
      </section>

      <!-- MULTAS -->
      <section id="multas" class="content-section">
        <h1 class="section-title">üí∞ Gesti√≥n de Multas</h1>
        <p class="section-subtitle">Multas pendientes y generadas por retraso en devoluciones</p>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Agregar Multa Manual</h2>
            <p class="card-description">Busque un estudiante y asigne una multa por infracci√≥n</p>
          </div>
          
          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchEstudianteMulta" class="search-input" placeholder="Buscar estudiante por nombre, ID o carrera..." onkeyup="buscarEstudiantesParaMulta()">
          </div>
          
          <div id="studentSearchResults" class="student-search-results" style="display: none;">
            <!-- Los resultados de b√∫squeda aparecer√°n aqu√≠ -->
          </div>
          
          <div id="selectedStudentInfo" class="student-info-card" style="display: none;">
            <h4>Estudiante Seleccionado</h4>
            <p id="selectedStudentName"></p>
            <p id="selectedStudentCareer"></p>
            <button class="btn btn-warning" onclick="mostrarFormularioMulta()" style="margin-top: 1rem;">
              <span>üí∞</span> Asignar Multa a este Estudiante
            </button>
          </div>
          
          <div style="margin-top: 2rem; text-align: center;">
            <button class="btn btn-primary" onclick="mostrarModalBusqueda()">
              <span>‚ûï</span> Buscar y Asignar Multa
            </button>
          </div>
        </div>
        
        <div class="card" style="margin-top: 2rem;">
          <div class="card-header">
            <h2 class="card-title">Multas pendientes</h2>
            <p class="card-description">Total de multas pendientes: <span id="totalMultas">0</span></p>
          </div>
          <div class="fines-container" id="multasList"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal para asignar multa -->
  <div id="multaModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üí∞ Asignar Multa</h2>
        <button class="modal-close" onclick="cerrarModalMulta()">√ó</button>
      </div>
      
      <div id="modalContent">
        <!-- Contenido din√°mico del modal -->
      </div>
    </div>
  </div>

  <script>
    // Datos del bibliotecario actual
    let currentUser = JSON.parse(localStorage.getItem('currentUser'));
    let selectedStudent = null;
    
    // Funciones principales
    function showSection(sectionId, element) {
      // Remover active de todas las secciones
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      
      // Agregar active a la secci√≥n seleccionada
      document.getElementById(sectionId).classList.add('active');
      element.classList.add('active');
      
      // Actualizar la secci√≥n mostrada
      if(sectionId === 'solicitudes') renderSolicitudes();
      else if(sectionId === 'prestamos') renderPrestamosActivos();
      else if(sectionId === 'devoluciones') renderDevoluciones();
      else if(sectionId === 'inventario') renderInventario();
      else if(sectionId === 'multas') renderMultas();
    }
    
    // ‚≠ê Mostrar solicitudes pendientes
    function renderSolicitudes() {
      const container = document.getElementById('requestsList');
      const solicitudes = JSON.parse(localStorage.getItem('solicitudes')) || [];
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const books = JSON.parse(localStorage.getItem('books')) || [];
      const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
      
      const solicitudesPendientes = solicitudes.filter(s => s.estado === 'pendiente');
      
      // Actualizar contador
      document.getElementById('totalSolicitudes').textContent = solicitudesPendientes.length;
      
      if(solicitudesPendientes.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div>üì≠</div>
            <h3>No hay solicitudes pendientes</h3>
            <p>Todas las solicitudes han sido procesadas</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = solicitudesPendientes.map(s => {
        const estudiante = users.find(u => u.id === s.estudianteId);
        const libro = books.find(b => b.id === s.libroId);
        
        // ‚úÖ VERIFICAR L√çMITE DE 2 LIBROS DEL ESTUDIANTE
        const prestamosEstudiante = prestamos.filter(p => 
            p.estudianteId === s.estudianteId && 
            p.estado === 'activo'
        ).length;
        
        const tieneLimite = prestamosEstudiante >= 2;
        
        return `
          <div class="request-item ${tieneLimite ? 'atrasado' : ''}">
            <div class="request-content">
              <h3 class="request-title">${libro ? libro.title : 'Libro no encontrado'}</h3>
              <p class="request-details">‚úçÔ∏è Autor: ${libro ? libro.author : 'N/A'}</p>
              <p class="request-details">üë§ Estudiante: ${estudiante ? estudiante.name : 'N/A'}</p>
              <p class="request-details">üéì Carrera: ${estudiante ? estudiante.career || 'No especificada' : 'N/A'}</p>
              ${tieneLimite ? `<p class="request-details" style="color:var(--danger); font-weight:600;">‚ö†Ô∏è ESTUDIANTE TIENE ${prestamosEstudiante}/2 LIBROS</p>` : ''}
              <div class="request-meta">
                <span>üìÖ ${s.fecha}</span>
                <span>‚è∞ Solicitud pendiente</span>
              </div>
            </div>
            <div class="request-actions">
              <button class="btn btn-success" onclick="aprobarSolicitud(${s.id})" ${tieneLimite ? 'disabled style="opacity:0.5;"' : ''}>
                <span>‚úÖ</span> ${tieneLimite ? 'L√≠mite alcanzado' : 'Aprobar'}
              </button>
              <button class="btn btn-danger" onclick="rechazarSolicitud(${s.id})">
                <span>‚ùå</span> Rechazar
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ‚≠ê Aprobar solicitud
    function aprobarSolicitud(solicitudId) {
      let solicitudes = JSON.parse(localStorage.getItem('solicitudes')) || [];
      let prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
      let books = JSON.parse(localStorage.getItem('books')) || [];
      let notificaciones = JSON.parse(localStorage.getItem('notificaciones')) || [];
      
      const solicitudIndex = solicitudes.findIndex(s => s.id === solicitudId);
      if(solicitudIndex === -1) return;
      
      const solicitud = solicitudes[solicitudIndex];
      
      // ‚úÖ VERIFICAR L√çMITE DE 2 LIBROS POR ESTUDIANTE
      const prestamosEstudiante = prestamos.filter(p => 
          p.estudianteId === solicitud.estudianteId && 
          p.estado === 'activo'
      ).length;
      
      if (prestamosEstudiante >= 2) {
          alert(`‚ùå El estudiante ${solicitud.estudianteNombre} ya tiene 2 libros en pr√©stamo. 
                 No puede solicitar m√°s hasta que devuelva alguno.`);
          
          // Rechazar autom√°ticamente la solicitud
          solicitudes[solicitudIndex].estado = 'rechazado';
          solicitudes[solicitudIndex].motivoRechazo = 'L√≠mite de 2 libros alcanzado';
          localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
          
          // Notificar al estudiante
          notificaciones.push({
              id: Date.now(),
              estudianteId: solicitud.estudianteId,
              mensaje: `‚ùå Tu solicitud para "${solicitud.libroTitulo}" fue rechazada porque ya tienes 2 libros en pr√©stamo. Devuelve uno para solicitar m√°s.`,
              tipo: 'rechazo',
              fecha: new Date().toLocaleString(),
              leida: false
          });
          localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
          
          alert('La solicitud ha sido rechazada autom√°ticamente por l√≠mite de libros.');
          renderSolicitudes();
          return;
      }
      
      // Crear pr√©stamo por 7 d√≠as
      const fechaPrestamo = new Date();
      const fechaDevolucion = new Date();
      fechaDevolucion.setDate(fechaDevolucion.getDate() + 7);
      
      const nuevoPrestamo = {
        id: Date.now(),
        libroId: solicitud.libroId,
        libroTitulo: solicitud.libroTitulo,
        estudianteId: solicitud.estudianteId,
        estudianteNombre: solicitud.estudianteNombre,
        fechaPrestamo: fechaPrestamo.toLocaleString(),
        fechaDevolucion: fechaDevolucion.toLocaleDateString(),
        estado: 'activo',
        multa: 0
      };
      
      prestamos.push(nuevoPrestamo);
      
      // Actualizar estado de la solicitud
      solicitudes[solicitudIndex].estado = 'aprobado';
      solicitudes[solicitudIndex].fechaAprobacion = new Date().toLocaleString();
      
      // ‚úÖ Marcar libro como no disponible
      const libroIndex = books.findIndex(b => b.id === solicitud.libroId);
      if(libroIndex !== -1) {
        books[libroIndex].available = false;
      }
      
      // Crear notificaci√≥n para el estudiante
      notificaciones.push({
        id: Date.now(),
        estudianteId: solicitud.estudianteId,
        mensaje: `‚úÖ Tu solicitud para "${solicitud.libroTitulo}" ha sido APROBADA. Fecha l√≠mite de devoluci√≥n: ${fechaDevolucion.toLocaleDateString()}`,
        tipo: 'aprobacion',
        fecha: new Date().toLocaleString(),
        leida: false
      });
      
      // Guardar todo
      localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
      localStorage.setItem('prestamos', JSON.stringify(prestamos));
      localStorage.setItem('books', JSON.stringify(books));
      localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
      
      alert('‚úÖ Pr√©stamo aprobado por 7 d√≠as.');
      renderSolicitudes();
      renderPrestamosActivos();
      renderDevoluciones();
    }
    
    // ‚≠ê Rechazar solicitud
    function rechazarSolicitud(solicitudId) {
      let solicitudes = JSON.parse(localStorage.getItem('solicitudes')) || [];
      let books = JSON.parse(localStorage.getItem('books')) || [];
      let notificaciones = JSON.parse(localStorage.getItem('notificaciones')) || [];
      
      const solicitudIndex = solicitudes.findIndex(s => s.id === solicitudId);
      if(solicitudIndex === -1) return;
      
      const solicitud = solicitudes[solicitudIndex];
      
      // Actualizar estado de la solicitud
      solicitudes[solicitudIndex].estado = 'rechazado';
      solicitudes[solicitudIndex].fechaRechazo = new Date().toLocaleString();
      
      // Marcar libro como disponible
      const libroIndex = books.findIndex(b => b.id === solicitud.libroId);
      if(libroIndex !== -1) {
        books[libroIndex].available = true;
      }
      
      // Crear notificaci√≥n para el estudiante
      notificaciones.push({
        id: Date.now(),
        estudianteId: solicitud.estudianteId,
        mensaje: `‚ùå Tu solicitud para "${solicitud.libroTitulo}" ha sido RECHAZADA.`,
        tipo: 'rechazo',
        fecha: new Date().toLocaleString(),
        leida: false
      });
      
      // Guardar todo
      localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
      localStorage.setItem('books', JSON.stringify(books));
      localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
      
      alert('‚ùå Solicitud rechazada.');
      renderSolicitudes();
    }
    
    // ‚≠ê Mostrar pr√©stamos activos
    function renderPrestamosActivos() {
      const container = document.getElementById('prestamosActivosList');
      const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
      
      const prestamosActivos = prestamos.filter(p => p.estado === 'activo' || p.estado === 'atrasado');
      
      if(prestamosActivos.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div>üìö</div>
            <h3>No hay pr√©stamos activos</h3>
            <p>Todos los libros est√°n disponibles</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = prestamosActivos.map(p => {
        const fechaDevolucion = new Date(p.fechaDevolucion);
        const hoy = new Date();
        const atrasado = hoy > fechaDevolucion;
        const diasAtraso = atrasado ? Math.floor((hoy - fechaDevolucion) / (1000 * 60 * 60 * 24)) : 0;
        
        return `
          <div class="request-item ${atrasado ? 'atrasado' : ''}">
            <div class="request-content">
              <h3 class="request-title">${p.libroTitulo}</h3>
              <p class="request-details">üë§ Estudiante: ${p.estudianteNombre}</p>
              <p class="request-details">üìÖ Pr√©stamo: ${p.fechaPrestamo}</p>
              <p class="request-details">‚è∞ Devuelve: ${p.fechaDevolucion}</p>
              ${atrasado ? `<p class="request-details" style="color:var(--danger);">‚ö†Ô∏è Atraso: ${diasAtraso} d√≠as</p>` : ''}
            </div>
            <div>
              <span class="status-badge ${atrasado ? 'badge-atrasado' : 'badge-activo'}">
                ${atrasado ? 'ATRASADO' : 'ACTIVO'}
              </span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ‚≠ê Filtrar pr√©stamos
    function filtrarPrestamos() {
      const search = document.getElementById('searchPrestamos').value.toLowerCase();
      const items = document.querySelectorAll('#prestamosActivosList .request-item');
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? 'flex' : 'none';
      });
    }
    
    // ‚≠ê Mostrar devoluciones pendientes
    function renderDevoluciones() {
      const container = document.getElementById('devolucionesList');
      const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
      
      const prestamosPorDevolver = prestamos.filter(p => p.estado === 'activo' || p.estado === 'atrasado');
      
      // Actualizar contador
      document.getElementById('totalPrestamos').textContent = prestamosPorDevolver.length;
      
      if(prestamosPorDevolver.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div>üìö</div>
            <h3>No hay pr√©stamos pendientes de devoluci√≥n</h3>
            <p>Todos los libros han sido devueltos</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = prestamosPorDevolver.map(p => {
        const fechaDevolucion = new Date(p.fechaDevolucion);
        const hoy = new Date();
        const atrasado = hoy > fechaDevolucion;
        const diasAtraso = atrasado ? Math.floor((hoy - fechaDevolucion) / (1000 * 60 * 60 * 24)) : 0;
        const multa = atrasado ? diasAtraso * 1000 : 0; // $1000 por d√≠a de atraso
        
        return `
          <div class="request-item ${atrasado ? 'atrasado' : ''}">
            <div class="request-content">
              <h3 class="request-title">${p.libroTitulo}</h3>
              <p class="request-details">üë§ Estudiante: ${p.estudianteNombre}</p>
              <p class="request-details">üìÖ Devuelve: ${p.fechaDevolucion}</p>
              ${atrasado ? `
                <p class="request-details" style="color:var(--danger);">
                  ‚ö†Ô∏è Atraso: ${diasAtraso} d√≠as | Multa: $${multa}
                </p>
              ` : ''}
            </div>
            <div class="request-actions">
              <button class="btn btn-success" onclick="registrarDevolucion(${p.id}, ${multa})">
                <span>‚úÖ</span> Registrar Devoluci√≥n
              </button>
              ${atrasado ? `
                <button class="btn btn-warning" onclick="generarMulta(${p.id}, ${multa}, ${diasAtraso})">
                  <span>üí∞</span> Generar Multa
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ‚≠ê Registrar devoluci√≥n
    function registrarDevolucion(prestamoId, multa) {
      let prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
      let books = JSON.parse(localStorage.getItem('books')) || [];
      let notificaciones = JSON.parse(localStorage.getItem('notificaciones')) || [];
      let multas = JSON.parse(localStorage.getItem('multas')) || [];
      
      const prestamoIndex = prestamos.findIndex(p => p.id === prestamoId);
      if(prestamoIndex === -1) return;
      
      const prestamo = prestamos[prestamoIndex];
      
      // ‚úÖ IMPORTANTE: Marcar libro como disponible
      const libroIndex = books.findIndex(b => b.id === prestamo.libroId);
      if(libroIndex !== -1) {
        books[libroIndex].available = true; // ‚úÖ LIBERAR EL LIBRO
        books[libroIndex].lastDevolucion = new Date().toLocaleString();
      }
      
      // Actualizar estado del pr√©stamo
      prestamos[prestamoIndex].estado = 'devuelto';
      prestamos[prestamoIndex].fechaDevolucionReal = new Date().toLocaleString();
      
      // Si hay multa, generarla
      if(multa > 0) {
        const nuevaMulta = {
          id: Date.now(),
          prestamoId: prestamoId,
          estudianteId: prestamo.estudianteId,
          estudianteNombre: prestamo.estudianteNombre,
          libroTitulo: prestamo.libroTitulo,
          monto: multa,
          diasAtraso: Math.floor(multa / 1000),
          fecha: new Date().toLocaleString(),
          estado: 'pendiente',
          motivo: 'Atraso en devoluci√≥n'
        };
        
        multas.push(nuevaMulta);
        
        // Notificaci√≥n al estudiante
        notificaciones.push({
          id: Date.now(),
          estudianteId: prestamo.estudianteId,
          mensaje: `üí∞ Tienes una multa de $${multa} por atraso en la devoluci√≥n de "${prestamo.libroTitulo}"`,
          tipo: 'multa',
          fecha: new Date().toLocaleString(),
          leida: false
        });
        
        localStorage.setItem('multas', JSON.stringify(multas));
      }
      
      // ‚úÖ NOTIFICAR AL ESTUDIANTE QUE YA PUEDE SOLICITAR OTRO LIBRO
      notificaciones.push({
        id: Date.now(),
        estudianteId: prestamo.estudianteId,
        mensaje: `‚úÖ Has devuelto "${prestamo.libroTitulo}" correctamente. 
                 Ahora puedes solicitar otro libro (m√°ximo 2 en total).`,
        tipo: 'devolucion',
        fecha: new Date().toLocaleString(),
        leida: false
      });
      
      // Guardar todo
      localStorage.setItem('prestamos', JSON.stringify(prestamos));
      localStorage.setItem('books', JSON.stringify(books));
      localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
      
      alert('‚úÖ Devoluci√≥n registrada correctamente. El estudiante puede solicitar otro libro.');
      renderDevoluciones();
      renderPrestamosActivos();
      renderMultas();
      renderInventario();
    }
    
    // ‚≠ê Generar multa por atraso
    function generarMulta(prestamoId, monto, diasAtraso) {
      let multas = JSON.parse(localStorage.getItem('multas')) || [];
      let prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
      let notificaciones = JSON.parse(localStorage.getItem('notificaciones')) || [];
      
      const prestamo = prestamos.find(p => p.id === prestamoId);
      if(!prestamo) return;
      
      // Verificar si ya existe multa para este pr√©stamo
      const multaExistente = multas.find(m => m.prestamoId === prestamoId);
      if(multaExistente) {
        alert('Ya existe una multa para este pr√©stamo.');
        return;
      }
      
      const nuevaMulta = {
        id: Date.now(),
        prestamoId: prestamoId,
        estudianteId: prestamo.estudianteId,
        estudianteNombre: prestamo.estudianteNombre,
        libroTitulo: prestamo.libroTitulo,
        monto: monto,
        diasAtraso: diasAtraso,
        fecha: new Date().toLocaleString(),
        estado: 'pendiente',
        motivo: 'Atraso en devoluci√≥n'
      };
      
      multas.push(nuevaMulta);
      
      // Notificaci√≥n al estudiante
      notificaciones.push({
        id: Date.now(),
        estudianteId: prestamo.estudianteId,
        mensaje: `‚ö†Ô∏è Tienes una multa de $${monto} por ${diasAtraso} d√≠as de atraso en "${prestamo.libroTitulo}"`,
        tipo: 'multa',
        fecha: new Date().toLocaleString(),
        leida: false
      });
      
      localStorage.setItem('multas', JSON.stringify(multas));
      localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
      
      alert(`üí∞ Multa de $${monto} generada por ${diasAtraso} d√≠as de atraso.`);
      renderMultas();
    }
    
    // ‚≠ê Mostrar inventario
    function renderInventario() {
      const container = document.getElementById('inventarioList');
      const books = JSON.parse(localStorage.getItem('books')) || [];
      const prestamos = JSON.parse(localStorage.getItem('prestamos')) || [];
      const search = document.getElementById('searchInventario').value.toLowerCase();
      
      // Mostrar loading
      container.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Cargando inventario...</p>
        </div>
      `;
      
      setTimeout(() => {
        // Filtrar libros seg√∫n b√∫squeda
        const filteredBooks = books.filter(b =>
          b.title.toLowerCase().includes(search) ||
          b.author.toLowerCase().includes(search) ||
          (b.category && b.category.toLowerCase().includes(search)) ||
          (b.isbn && b.isbn.includes(search))
        );
        
        if(filteredBooks.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div>üìö</div>
              <h3>No se encontraron libros</h3>
              <p>Intenta con otros t√©rminos de b√∫squeda</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = filteredBooks.map(libro => {
          // Verificar estado del libro
          const prestamoActivo = prestamos.find(p => p.libroId === libro.id && (p.estado === 'activo' || p.estado === 'atrasado'));
          const disponible = libro.available && !prestamoActivo;
          
          return `
            <div class="book-card">
              <div class="book-image">
                <img src="${libro.img || 'img/book-placeholder.png'}" alt="${libro.title}">
              </div>
              <div class="book-info">
                <h3 class="book-title">${libro.title}</h3>
                <p class="book-details">‚úçÔ∏è ${libro.author}</p>
                <p class="book-details">üìÖ ${libro.year} | üè∑Ô∏è ${libro.category || 'General'}</p>
                <p class="book-details">üî¢ ISBN: ${libro.isbn || 'No disponible'}</p>
                <div class="book-status-container">
                  <span class="status-badge ${disponible ? 'badge-activo' : 'badge-atrasado'}">
                    ${disponible ? 'DISPONIBLE' : 'PRESTADO'}
                  </span>
                  ${prestamoActivo ? `<span class="book-details">üë§ ${prestamoActivo.estudianteNombre}</span>` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }, 500); // Simular tiempo de carga
    }
    
    // ‚≠ê Buscar estudiantes para multa
    function buscarEstudiantesParaMulta() {
      const search = document.getElementById('searchEstudianteMulta').value.toLowerCase();
      const container = document.getElementById('studentSearchResults');
      const users = JSON.parse(localStorage.getItem('users')) || [];
      
      // Filtrar solo estudiantes
      const estudiantes = users.filter(u => u.role === 'estudiante');
      
      if (!search) {
        container.style.display = 'none';
        return;
      }
      
      const resultados = estudiantes.filter(est => 
        est.name.toLowerCase().includes(search) || 
        est.id.toString().includes(search) || 
        (est.career && est.career.toLowerCase().includes(search)) ||
        (est.email && est.email.toLowerCase().includes(search))
      );
      
      if(resultados.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 1rem;">
            <div>üë§</div>
            <h3>No se encontraron estudiantes</h3>
            <p>Prueba con otro t√©rmino de b√∫squeda</p>
          </div>
        `;
        container.style.display = 'block';
        return;
      }
      
      container.innerHTML = resultados.map(est => `
        <div class="student-result-item" onclick="seleccionarEstudiante(${est.id}, '${est.name}', '${est.career || 'No especificada'}')">
          <h4 style="margin-bottom: 0.25rem;">${est.name}</h4>
          <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0.25rem;">üéì ${est.career || 'Carrera no especificada'}</p>
          <p style="color: var(--gray); font-size: 0.9rem;">üìß ${est.email || 'Email no especificado'}</p>
        </div>
      `).join('');
      
      container.style.display = 'block';
    }
    
    // ‚≠ê Seleccionar estudiante para multa
    function seleccionarEstudiante(id, name, career) {
      selectedStudent = { id, name, career };
      
      // Actualizar UI
      document.getElementById('selectedStudentName').textContent = `üë§ ${name}`;
      document.getElementById('selectedStudentCareer').textContent = `üéì ${career}`;
      document.getElementById('selectedStudentInfo').style.display = 'block';
      document.getElementById('studentSearchResults').style.display = 'none';
      document.getElementById('searchEstudianteMulta').value = '';
    }
    
    // ‚≠ê Mostrar formulario de multa
    function mostrarFormularioMulta() {
      if (!selectedStudent) {
        alert('Por favor selecciona un estudiante primero.');
        return;
      }
      
      const modal = document.getElementById('multaModal');
      const modalContent = document.getElementById('modalContent');
      
      modalContent.innerHTML = `
        <div class="student-info-card" style="margin-bottom: 1.5rem;">
          <h4>Estudiante Seleccionado</h4>
          <p><strong>üë§ Nombre:</strong> ${selectedStudent.name}</p>
          <p><strong>üéì Carrera:</strong> ${selectedStudent.career}</p>
        </div>
        
        <form id="formAgregarMulta">
          <div class="form-group">
            <label for="montoMulta" class="form-label">üí∞ Monto de la Multa ($)</label>
            <input type="number" id="montoMulta" class="form-input" min="0" step="100" placeholder="Ej: 5000" required>
            <small style="color: var(--gray); display: block; margin-top: 0.25rem;">Ingresa el monto en pesos chilenos</small>
          </div>
          
          <div class="form-group">
            <label for="motivoMulta" class="form-label">üìù Motivo de la Multa</label>
            <select id="motivoMulta" class="form-select" required>
              <option value="">Selecciona un motivo</option>
              <option value="Da√±o a libro">Da√±o a libro</option>
              <option value="P√©rdida de libro">P√©rdida de libro</option>
              <option value="Atraso en devoluci√≥n">Atraso en devoluci√≥n</option>
              <option value="Comportamiento inadecuado">Comportamiento inadecuado</option>
              <option value="Otro">Otro motivo</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="descripcionMulta" class="form-label">üìã Descripci√≥n Detallada</label>
            <textarea id="descripcionMulta" class="form-textarea" placeholder="Describe en detalle el motivo de la multa..." required></textarea>
          </div>
          
          <div class="form-group">
            <label for="fechaMulta" class="form-label">üìÖ Fecha de la Infracci√≥n</label>
            <input type="date" id="fechaMulta" class="form-input" value="${new Date().toISOString().split('T')[0]}" required>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-danger" onclick="cerrarModalMulta()">
              <span>‚ùå</span> Cancelar
            </button>
            <button type="submit" class="btn btn-success">
              <span>üí∞</span> Asignar Multa
            </button>
          </div>
        </form>
      `;
      
      // Configurar el formulario
      document.getElementById('formAgregarMulta').addEventListener('submit', function(e) {
        e.preventDefault();
        asignarMultaManual();
      });
      
      modal.classList.add('active');
    }
    
    // ‚≠ê Mostrar modal de b√∫squeda
    function mostrarModalBusqueda() {
      const modal = document.getElementById('multaModal');
      const modalContent = document.getElementById('modalContent');
      
      modalContent.innerHTML = `
        <div class="search-container" style="margin-bottom: 1.5rem;">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchEstudianteModal" class="search-input" placeholder="Buscar estudiante por nombre, ID o carrera..." onkeyup="buscarEstudiantesModal()">
        </div>
        
        <div id="modalSearchResults" class="student-search-results" style="max-height: 300px;">
          <div class="empty-state" style="padding: 1rem;">
            <div>üë§</div>
            <h3>Buscar estudiantes</h3>
            <p>Escribe el nombre, ID o carrera del estudiante</p>
          </div>
        </div>
      `;
      
      modal.classList.add('active');
    }
    
    // ‚≠ê Buscar estudiantes en modal
    function buscarEstudiantesModal() {
      const search = document.getElementById('searchEstudianteModal').value.toLowerCase();
      const container = document.getElementById('modalSearchResults');
      const users = JSON.parse(localStorage.getItem('users')) || [];
      
      // Filtrar solo estudiantes
      const estudiantes = users.filter(u => u.role === 'estudiante');
      
      if (!search) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 1rem;">
            <div>üë§</div>
            <h3>Buscar estudiantes</h3>
            <p>Escribe el nombre, ID o carrera del estudiante</p>
          </div>
        `;
        return;
      }
      
      const resultados = estudiantes.filter(est => 
        est.name.toLowerCase().includes(search) || 
        est.id.toString().includes(search) || 
        (est.career && est.career.toLowerCase().includes(search)) ||
        (est.email && est.email.toLowerCase().includes(search))
      );
      
      if(resultados.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 1rem;">
            <div>üë§</div>
            <h3>No se encontraron estudiantes</h3>
            <p>Prueba con otro t√©rmino de b√∫squeda</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = resultados.map(est => `
        <div class="student-result-item" onclick="seleccionarEstudianteModal(${est.id}, '${est.name}', '${est.career || 'No especificada'}')">
          <h4 style="margin-bottom: 0.25rem;">${est.name}</h4>
          <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0.25rem;">üéì ${est.career || 'Carrera no especificada'}</p>
          <p style="color: var(--gray); font-size: 0.9rem;">üìß ${est.email || 'Email no especificado'}</p>
        </div>
      `).join('');
    }
    
    // ‚≠ê Seleccionar estudiante en modal
    function seleccionarEstudianteModal(id, name, career) {
      selectedStudent = { id, name, career };
      mostrarFormularioMulta();
    }
    
    // ‚≠ê Asignar multa manual
    function asignarMultaManual() {
      const monto = parseInt(document.getElementById('montoMulta').value);
      const motivo = document.getElementById('motivoMulta').value;
      const descripcion = document.getElementById('descripcionMulta').value;
      const fecha = document.getElementById('fechaMulta').value;
      
      if (!selectedStudent || !monto || !motivo || !descripcion || !fecha) {
        alert('Por favor completa todos los campos.');
        return;
      }
      
      let multas = JSON.parse(localStorage.getItem('multas')) || [];
      let notificaciones = JSON.parse(localStorage.getItem('notificaciones')) || [];
      
      const nuevaMulta = {
        id: Date.now(),
        estudianteId: selectedStudent.id,
        estudianteNombre: selectedStudent.name,
        libroTitulo: 'Multa administrativa',
        monto: monto,
        motivo: motivo,
        descripcion: descripcion,
        fecha: new Date().toLocaleString(),
        fechaInfraccion: fecha,
        estado: 'pendiente',
        tipo: 'manual'
      };
      
      multas.push(nuevaMulta);
      
      // Notificaci√≥n al estudiante
      notificaciones.push({
        id: Date.now(),
        estudianteId: selectedStudent.id,
        mensaje: `üí∞ Se te ha asignado una multa de $${monto} por: ${motivo} - ${descripcion}`,
        tipo: 'multa',
        fecha: new Date().toLocaleString(),
        leida: false
      });
      
      localStorage.setItem('multas', JSON.stringify(multas));
      localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
      
      alert(`‚úÖ Multa de $${monto} asignada a ${selectedStudent.name}.`);
      cerrarModalMulta();
      renderMultas();
      
      // Limpiar selecci√≥n
      selectedStudent = null;
      document.getElementById('selectedStudentInfo').style.display = 'none';
      document.getElementById('searchEstudianteMulta').value = '';
    }
    
    // ‚≠ê Cerrar modal
    function cerrarModalMulta() {
      document.getElementById('multaModal').classList.remove('active');
      selectedStudent = null;
    }
    
    // ‚≠ê Mostrar multas
    function renderMultas() {
      const container = document.getElementById('multasList');
      const multas = JSON.parse(localStorage.getItem('multas')) || [];
      
      const multasPendientes = multas.filter(m => m.estado === 'pendiente');
      
      // Actualizar contador
      document.getElementById('totalMultas').textContent = multasPendientes.length;
      
      if(multasPendientes.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div>üí∞</div>
            <h3>No hay multas pendientes</h3>
            <p>Todas las multas han sido pagadas o no hay multas registradas</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = multasPendientes.map(m => `
        <div class="fine-item ${m.diasAtraso ? 'atrasado' : ''}">
          <div class="fine-content">
            <h4>${m.libroTitulo}</h4>
            <p class="fine-details">üë§ ${m.estudianteNombre}</p>
            <p class="fine-details">üìÖ ${m.fecha}</p>
            <p class="fine-details"><strong>üìù Motivo:</strong> ${m.motivo}</p>
            ${m.descripcion ? `<p class="fine-details"><strong>üìã Descripci√≥n:</strong> ${m.descripcion}</p>` : ''}
            ${m.diasAtraso ? `<p class="fine-details">‚è∞ Atraso: ${m.diasAtraso} d√≠as</p>` : ''}
            ${m.tipo === 'manual' ? `<span class="status-badge" style="background: var(--warning); margin-top: 0.5rem;">MANUAL</span>` : ''}
          </div>
          <div style="text-align: right;">
            <div class="fine-amount">$${m.monto}</div>
            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-direction: column;">
              <button class="btn btn-success" style="padding: 0.5rem 1rem;" onclick="marcarMultaPagada(${m.id})">
                ‚úÖ Marcar como Pagada
              </button>
              <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="eliminarMulta(${m.id})">
                ‚ùå Eliminar Multa
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // ‚≠ê Marcar multa como pagada
    function marcarMultaPagada(multaId) {
      if(!confirm('¬øEst√° seguro de marcar esta multa como pagada?')) return;
      
      let multas = JSON.parse(localStorage.getItem('multas')) || [];
      let notificaciones = JSON.parse(localStorage.getItem('notificaciones')) || [];
      
      const multaIndex = multas.findIndex(m => m.id === multaId);
      if(multaIndex === -1) return;
      
      const multa = multas[multaIndex];
      
      multas[multaIndex].estado = 'pagada';
      multas[multaIndex].fechaPago = new Date().toLocaleString();
      
      // Notificar al estudiante
      notificaciones.push({
        id: Date.now(),
        estudianteId: multa.estudianteId,
        mensaje: `‚úÖ Multa de $${multa.monto} por "${multa.motivo}" ha sido marcada como PAGADA.`,
        tipo: 'multa_pagada',
        fecha: new Date().toLocaleString(),
        leida: false
      });
      
      localStorage.setItem('multas', JSON.stringify(multas));
      localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
      
      alert('‚úÖ Multa marcada como pagada.');
      renderMultas();
    }
    
    // ‚≠ê Eliminar multa
    function eliminarMulta(multaId) {
      if(!confirm('¬øEst√° seguro de eliminar esta multa? Esta acci√≥n no se puede deshacer.')) return;
      
      let multas = JSON.parse(localStorage.getItem('multas')) || [];
      let notificaciones = JSON.parse(localStorage.getItem('notificaciones')) || [];
      
      const multaIndex = multas.findIndex(m => m.id === multaId);
      if(multaIndex === -1) return;
      
      const multa = multas[multaIndex];
      
      // Notificar al estudiante si la multa estaba pendiente
      if (multa.estado === 'pendiente') {
        notificaciones.push({
          id: Date.now(),
          estudianteId: multa.estudianteId,
          mensaje: `‚ùå Multa de $${multa.monto} por "${multa.motivo}" ha sido ELIMINADA por el bibliotecario.`,
          tipo: 'multa_eliminada',
          fecha: new Date().toLocaleString(),
          leida: false
        });
      }
      
      multas.splice(multaIndex, 1);
      
      localStorage.setItem('multas', JSON.stringify(multas));
      localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
      
      alert('‚úÖ Multa eliminada correctamente.');
      renderMultas();
    }
    
    // ‚≠ê Actualizar avatar del usuario
    function updateUserAvatar() {
      if(currentUser && currentUser.name) {
        const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
        document.getElementById('userAvatar').textContent = initials;
      }
    }
    
    // ‚≠ê Logout
    function logout() {
      if(confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }
    }
    
    // ‚≠ê Inicializaci√≥n
    function init() {
      if(!currentUser || currentUser.role !== 'bibliotecario') {
        window.location.href = 'index.html';
        return;
      }
      
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userRole').textContent = 'Bibliotecario';
      document.getElementById('lastAccess').textContent = '√öltimo acceso: ' + (localStorage.getItem('lastAccessTime') || 'Ahora');
      
      updateUserAvatar();
      renderSolicitudes();
      renderPrestamosActivos();
      renderDevoluciones();
      renderInventario();
      renderMultas();
      
      // Actualizar autom√°ticamente cada 10 segundos
      setInterval(() => {
        renderSolicitudes();
        renderPrestamosActivos();
      }, 10000);
    }
    
    // Cerrar modal al hacer clic fuera
    document.getElementById('multaModal').addEventListener('click', function(e) {
      if (e.target === this) {
        cerrarModalMulta();
      }
    });
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>